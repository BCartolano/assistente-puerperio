<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="theme-color" content="#f4a6a6">
    <meta name="description" content="Recupere sua senha - Sophia - Sua Amiga do Puerp√©rio">
    <title>Recuperar Senha - Sophia üíï</title>
    
    <!-- Preload recursos cr√≠ticos -->
    <link rel="preload" href="{{ url_for('static', filename='css/style.css') }}?v={{ timestamp if timestamp else '1.0' }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ timestamp if timestamp else '1.0' }}"></noscript>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    
    <!-- CSS cr√≠tico inline -->
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        html,body{
            height:100vh;
            overflow:hidden;
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
        }
        body{
            background:linear-gradient(135deg,#f8f4f0 0%,#e8d5d1 50%,#d4c5c0 100%);
            display:flex;
            align-items:center;
            justify-content:center;
            color:#5a4a42
        }
        .forgot-password-container{
            background:#fff !important;
            border-radius:25px !important;
            padding:3rem !important;
            padding-bottom:4rem !important;
            max-width:450px !important;
            width:90% !important;
            box-shadow:0 10px 40px rgba(244,166,166,0.3) !important;
            box-sizing:border-box !important;
            animation:slideUp 0.5s ease !important;
            overflow:visible !important
        }
        @keyframes slideUp{
            from{opacity:0;transform:translateY(20px)}
            to{opacity:1;transform:translateY(0)}
        }
        .forgot-password-header{
            text-align:center;
            margin-bottom:2rem
        }
        .forgot-password-header i{
            font-size:3rem;
            color:#f4a6a6;
            margin-bottom:0.5rem
        }
        .forgot-password-header h1{
            font-size:2rem;
            color:#8b5a5a;
            margin:0;
            font-family:'Nunito',sans-serif
        }
        .forgot-password-header p{
            color:#8b5a5a;
            font-size:0.9rem;
            margin-top:0.5rem
        }
        .back-link{
            display:inline-flex;
            align-items:center;
            gap:0.5rem;
            color:#f4a6a6;
            text-decoration:none;
            margin-bottom:1.5rem;
            font-size:0.9rem;
            transition:all 0.3s ease
        }
        .back-link:hover{
            color:#e8b4b8;
            transform:translateX(-5px)
        }
        .forgot-password-content .form-group{
            margin-bottom:1.2rem;
            position:relative;
            width:100%;
            box-sizing:border-box
        }
        .forgot-password-content .form-group label{
            display:block;
            margin-bottom:0.5rem;
            color:#8b5a5a;
            font-weight:500;
            font-size:0.9rem
        }
        .forgot-password-content .form-group label i{
            display:none
        }
        .forgot-password-content .form-group input{
            width:100% !important;
            padding:1rem 1rem 1rem 3.5rem !important;
            border:2px solid rgba(244,166,166,0.3) !important;
            border-radius:12px !important;
            font-size:1rem !important;
            transition:border-color 0.3s ease,box-shadow 0.3s ease !important;
            background:#fff9f7 !important;
            box-sizing:border-box !important;
            position:relative !important;
            font-family:inherit !important;
            line-height:1.5rem !important
        }
        .forgot-password-content .form-group input:focus{
            outline:none;
            border-color:#f4a6a6;
            background:white;
            box-shadow:0 0 0 3px rgba(244,166,166,0.1)
        }
        .forgot-password-content .form-group::after{
            content:"\f0e0" !important;
            font-family:"Font Awesome 6 Free" !important;
            font-weight:900 !important;
            position:absolute !important;
            left:1.3rem !important;
            top:2.55rem !important;
            z-index:10 !important;
            pointer-events:none !important;
            color:#f4a6a6 !important;
            font-size:1.1rem !important;
            line-height:1.5rem !important;
            height:1.5rem !important;
            display:flex !important;
            align-items:center !important;
            justify-content:center !important;
            width:1.2rem !important
        }
        .forgot-password-message{
            font-size:0.9rem;
            line-height:1.5
        }
        .forgot-password-content .btn-login-main {
            width: 100% !important;
            overflow: visible !important;
            white-space: nowrap !important;
            word-wrap: normal !important;
            text-overflow: clip !important;
            padding: 1.4rem 2rem !important;
            min-height: 70px !important;
            font-size: 1.2rem !important;
            font-weight: 600 !important;
            border-radius: 12px !important;
            display: flex !important;
            align-items: center !important;
            justify-content: center !important;
            gap: 0.7rem !important;
            box-sizing: border-box !important;
        }
        @media (max-width: 768px) {
            .forgot-password-container {
                padding: 2rem 1.5rem !important;
                max-width: 95% !important;
                padding-bottom: 4rem !important;
                overflow: visible !important;
            }
            .forgot-password-header h1 {
                font-size: 1.5rem;
            }
            .forgot-password-header i {
                font-size: 2.5rem;
            }
            .forgot-password-content p {
                font-size: 0.9rem;
            }
            .forgot-password-content .form-group::after {
                top: 2.6rem !important;
                left: 1.3rem !important;
                font-size: 1.15rem !important;
            }
            .forgot-password-content .form-group input {
                padding-left: 3.8rem !important;
                font-size: 1.05rem !important;
            }
            .forgot-password-content .btn-login-main {
                padding: 1.5rem 2rem !important;
                font-size: 1.25rem !important;
                min-height: 75px !important;
                border-radius: 12px !important;
                white-space: nowrap !important;
                overflow: visible !important;
            }
        }
    </style>
    
    <!-- Fontes (carregamento otimizado) -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all'">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&family=Nunito:wght@400;600;700&display=swap" rel="stylesheet"></noscript>
    
    <!-- Font Awesome (carregamento otimizado) -->
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet"></noscript>
</head>
<body>
    <div class="forgot-password-container">
        <a href="/" class="back-link">
            <i class="fas fa-arrow-left"></i>
            Voltar ao Login
        </a>
        
        <div class="forgot-password-header">
            <i class="fas fa-key"></i>
            <h1>Recuperar Senha üîë</h1>
            <p>Sophia - Sua Amiga do Puerp√©rio</p>
        </div>
        
        <div class="forgot-password-content">
            {% if token and token_valid %}
            <!-- Formul√°rio de reset de senha (quando tem token v√°lido) -->
            <p style="color: #8b5a5a; margin-bottom: 2rem; text-align: center; line-height: 1.6;">
                Digite sua nova senha abaixo. üîê
            </p>
            
            <form id="reset-password-form">
                <input type="hidden" id="reset-token" value="{{ token }}">
                <div class="form-group">
                    <label for="reset-password-new">
                        <i class="fas fa-lock"></i>
                        Nova Senha
                    </label>
                    <input type="password" id="reset-password-new" name="password" autocomplete="new-password" placeholder="M√≠nimo 6 caracteres" required minlength="6">
                </div>
                <div class="form-group">
                    <label for="reset-password-confirm">
                        <i class="fas fa-lock"></i>
                        Confirmar Nova Senha
                    </label>
                    <input type="password" id="reset-password-confirm" name="password_confirm" autocomplete="new-password" placeholder="Digite a senha novamente" required minlength="6">
                </div>
                
                <button type="submit" class="btn btn-login-main">
                    <i class="fas fa-check"></i>
                    Redefinir Senha
                </button>
            </form>
            
            <div id="reset-password-message" class="forgot-password-message" style="display: none; margin-top: 1.5rem; padding: 1rem; border-radius: 12px; text-align: center;"></div>
            {% elif token and not token_valid %}
            <!-- Token inv√°lido ou expirado -->
            <div style="text-align: center; padding: 2rem;">
                <p style="color: #d32f2f; margin-bottom: 1.5rem; font-size: 1.1rem;">
                    ‚ö†Ô∏è Token inv√°lido ou expirado
                </p>
                <p style="color: #8b5a5a; margin-bottom: 2rem;">
                    O link de recupera√ß√£o n√£o √© v√°lido ou j√° expirou. Por favor, solicite um novo link.
                </p>
                <a href="/forgot-password" class="btn btn-login-main" style="display: inline-block; text-decoration: none;">
                    <i class="fas fa-redo"></i>
                    Solicitar Novo Link
                </a>
            </div>
            {% else %}
            <!-- Formul√°rio de solicita√ß√£o de recupera√ß√£o (sem token) -->
            <p style="color: #8b5a5a; margin-bottom: 2rem; text-align: center; line-height: 1.6;">
                Digite seu e-mail cadastrado e enviaremos um link para voc√™ redefinir sua senha. üíï
            </p>
            
            <form id="forgot-password-form">
                <div class="form-group">
                    <label for="forgot-password-email">
                        <i class="fas fa-envelope"></i>
                        E-mail
                    </label>
                    <input type="email" id="forgot-password-email" name="email" autocomplete="email" placeholder="seu@email.com" required>
                </div>
                
                <button type="submit" class="btn btn-login-main">
                    <i class="fas fa-paper-plane"></i>
                    Clique para Recuperar
                </button>
            </form>
            
            <div id="forgot-password-message" class="forgot-password-message" style="display: none; margin-top: 1.5rem; padding: 1rem; border-radius: 12px; text-align: center;"></div>
            {% endif %}
        </div>
    </div>

    <!-- Scripts -->
    <!-- N√£o carregamos chat.js aqui pois n√£o √© necess√°rio para esta p√°gina -->
    <script>
        // Script espec√≠fico para a p√°gina de recupera√ß√£o de senha
        document.addEventListener('DOMContentLoaded', function() {
            // Formul√°rio de solicita√ß√£o de recupera√ß√£o (sem token)
            const forgotForm = document.getElementById('forgot-password-form');
            if (forgotForm) {
                const messageDiv = document.getElementById('forgot-password-message');
                const emailInput = document.getElementById('forgot-password-email');
                
                forgotForm.addEventListener('submit', async function(e) {
                e.preventDefault();
                
                const email = emailInput.value.trim().toLowerCase();
                
                if (!email) {
                    showMessage('Por favor, digite seu e-mail! üíï', 'error');
                    return;
                }
                
                // Valida√ß√£o b√°sica de e-mail
                const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
                if (!emailRegex.test(email)) {
                    showMessage('Por favor, digite um e-mail v√°lido! üíï', 'error');
                    return;
                }
                
                try {
                    // Desabilita o bot√£o durante o envio
                    const submitBtn = forgotForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Enviando...';
                    
                    const response = await fetch('/api/forgot-password', {
                        method: 'POST',
                        headers: {'Content-Type': 'application/json'},
                        body: JSON.stringify({email: email})
                    });
                    
                    const data = await response.json();
                    
                    if (response.ok) {
                        showMessage('üìß ' + data.mensagem, 'success');
                        forgotForm.style.display = 'none';
                        emailInput.value = '';
                    } else {
                        showMessage('‚ö†Ô∏è ' + (data.erro || data.mensagem || 'Erro ao solicitar recupera√ß√£o'), 'error');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Clique para Recuperar';
                    }
                } catch (error) {
                    console.error('Erro ao solicitar recupera√ß√£o:', error);
                    showMessage('‚ùå Erro ao solicitar recupera√ß√£o. Tente novamente.', 'error');
                    const submitBtn = forgotForm.querySelector('button[type="submit"]');
                    submitBtn.disabled = false;
                    submitBtn.innerHTML = '<i class="fas fa-paper-plane"></i> Clique para Recuperar';
                }
            });
            
            function showMessage(message, type) {
                messageDiv.textContent = message;
                messageDiv.style.display = 'block';
                
                if (type === 'success') {
                    messageDiv.style.background = 'rgba(168, 213, 168, 0.2)';
                    messageDiv.style.border = '2px solid #a8d5a8';
                    messageDiv.style.color = '#2d5a2d';
                } else {
                    messageDiv.style.background = 'rgba(244, 166, 166, 0.2)';
                    messageDiv.style.border = '2px solid #f4a6a6';
                    messageDiv.style.color = '#8b5a5a';
                }
                
                // Scroll para a mensagem
                messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
            }
            }
            
            // Formul√°rio de reset de senha (com token)
            const resetForm = document.getElementById('reset-password-form');
            if (resetForm) {
                const messageDiv = document.getElementById('reset-password-message');
                const tokenInput = document.getElementById('reset-token');
                const passwordInput = document.getElementById('reset-password-new');
                const passwordConfirmInput = document.getElementById('reset-password-confirm');
                
                resetForm.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const token = tokenInput.value.trim();
                    const password = passwordInput.value;
                    const passwordConfirm = passwordConfirmInput.value;
                    
                    if (!password || password.length < 6) {
                        showResetMessage('A senha deve ter no m√≠nimo 6 caracteres! üíï', 'error');
                        return;
                    }
                    
                    if (password !== passwordConfirm) {
                        showResetMessage('As senhas n√£o coincidem! Por favor, digite novamente. üíï', 'error');
                        return;
                    }
                    
                    try {
                        const submitBtn = resetForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = true;
                        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Redefinindo...';
                        
                        const response = await fetch('/api/reset-password', {
                            method: 'POST',
                            headers: {'Content-Type': 'application/json'},
                            body: JSON.stringify({token: token, password: password})
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok) {
                            showResetMessage('‚úÖ ' + (data.mensagem || 'Senha redefinida com sucesso! Voc√™ pode fazer login agora.'), 'success');
                            resetForm.style.display = 'none';
                            setTimeout(function() {
                                window.location.href = '/';
                            }, 2000);
                        } else {
                            showResetMessage('‚ö†Ô∏è ' + (data.erro || 'Erro ao redefinir senha'), 'error');
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-check"></i> Redefinir Senha';
                        }
                    } catch (error) {
                        console.error('Erro ao redefinir senha:', error);
                        showResetMessage('‚ùå Erro ao redefinir senha. Tente novamente.', 'error');
                        const submitBtn = resetForm.querySelector('button[type="submit"]');
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-check"></i> Redefinir Senha';
                    }
                });
                
                function showResetMessage(message, type) {
                    messageDiv.textContent = message;
                    messageDiv.style.display = 'block';
                    
                    if (type === 'success') {
                        messageDiv.style.background = 'rgba(168, 213, 168, 0.2)';
                        messageDiv.style.border = '2px solid #a8d5a8';
                        messageDiv.style.color = '#2d5a2d';
                    } else {
                        messageDiv.style.background = 'rgba(244, 166, 166, 0.2)';
                        messageDiv.style.border = '2px solid #f4a6a6';
                        messageDiv.style.color = '#8b5a5a';
                    }
                    
                    messageDiv.scrollIntoView({ behavior: 'smooth', block: 'nearest' });
                }
            }
        });
    </script>
</body>
</html>

