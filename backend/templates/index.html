<!DOCTYPE html>
<html lang="pt-BR" data-page="{{ page|default('app') }}">
<head>
    {% include '_perf_head_links.html' %}
    {% include '_csp_meta.html' %}
    <!-- 0102: preload das imagens dos cards educativos (3 temas oficiais) -->
    <link rel="preload" href="{{ url_for('static', filename='img/edu/cancer-mama.png') }}" as="image">
    <link rel="preload" href="{{ url_for('static', filename='img/edu/doacao-leite-materno.png') }}" as="image">
    <link rel="preload" href="{{ url_for('static', filename='img/edu/aleitamento.png') }}" as="image">
    <!-- Dedupe de /api/user e /api/educational (carregar antes de qualquer fetch a essas APIs) -->
    <script src="/static/js/fetch-deduped.js?v={{ timestamp }}"></script>
    <!-- Namespacing autom√°tico do localStorage (carregar antes dos demais scripts) -->
    <script src="/static/js/storage-namespace.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/geo-autostart.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/debug-guard.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/flags-override-wire.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/version-watchdog.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/disable-autologin.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/login-forgot-wire.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/emergency-headers-wire.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/nearby-headers-wire.js?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/hospitals-ux-bundle.js') }}?v={{ timestamp }}" defer></script>
    <script src="/static/js/hospitals-hud-wire.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/hospitals-offline-wire.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/kill-searchlog-wire.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/kill-gps-refresh-wire.js?v={{ timestamp }}" defer></script>
    <script src="/static/js/debug-drawer.js?v={{ timestamp }}" defer></script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <link rel="manifest" href="/manifest.json">
    <meta name="mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Sophia">
    <meta name="theme-color" content="#ff8fa3">
    <meta name="msapplication-TileColor" content="#ff8fa3">
    <meta name="format-detection" content="telephone=no">
    <meta name="format-detection" content="address=no">
    <meta name="format-detection" content="email=no">
    <meta name="description" content="Sophia - Sua Companheira no Puerp√©rio. Espa√ßo acolhedor para o puerp√©rio ‚Äî apoio, acolhimento e conversas humanizadas com intelig√™ncia artificial emp√°tica.">
    <title>Sophia - Sua Companheira no Puerp√©rio ü§±</title>
    
    <!-- Resource Hints Otimizados -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link rel="dns-prefetch" href="https://cdnjs.cloudflare.com">
    <link rel="dns-prefetch" href="https://fonts.googleapis.com">
    <link rel="dns-prefetch" href="https://fonts.gstatic.com">
    <link rel="preconnect" href="https://api.groq.com" crossorigin>
    <link rel="dns-prefetch" href="//api.groq.com">
    <script src="{{ url_for('static', filename='js/perf-prefetch.js') }}?v={{ timestamp }}" defer></script>
    
    <!-- Google Fonts - Playfair Display (Tipografia Serifada) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&display=swap" rel="stylesheet">
    
    <!-- Configura√ß√£o de fallbacks (gerado pelo Jinja2, n√£o √© JavaScript) -->
    {% if has_minified and timestamp %}
    <script type="application/json" id="app-config">{"fallbacks":{"css":"{{ url_for('static', filename='css/style.css')|e }}?v={{ timestamp|e }}","js":"{{ url_for('static', filename='js/chat.js')|e }}?v={{ timestamp|e }}"}}</script>
    {% endif %}
    
    <!-- Preload recursos cr√≠ticos (usar minificado se dispon√≠vel) -->
    {% if has_minified and timestamp %}
    <link rel="preload" href="{{ url_for('static', filename='css/style.min.css') }}?v={{ timestamp }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/style.min.css') }}?v={{ timestamp }}"></noscript>
    {% elif timestamp %}
    <link rel="preload" href="{{ url_for('static', filename='css/style.css') }}?v={{ timestamp }}" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v={{ timestamp }}"></noscript>
    {% else %}
    <link rel="preload" href="{{ url_for('static', filename='css/style.css') }}?v=1.0" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link rel="stylesheet" href="{{ url_for('static', filename='css/style.css') }}?v=1.0"></noscript>
    {% endif %}
    
    <!-- CSS Timeline de Vacina√ß√£o -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/vaccination-timeline.css') }}?v={{ timestamp }}">
    
    <!-- CSS Feedback Modal -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/feedback-modal.css') }}?v={{ timestamp }}">
    
    <!-- CSS Card Ownership (chips P√∫blico/Privado/Filantr√≥pico) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/card-ownership.css') }}?v={{ timestamp }}">
    <!-- CSS Conte√∫dos Educativos (grid responsiva + cards) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/educational-cards.css') }}?v={{ timestamp }}">
    <!-- CSS Tema (tipografia e bot√µes) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme-polish.css') }}?v={{ timestamp }}">
    <!-- CSS Categorias da Home (grid Guias/Gesta√ß√£o/P√≥s-Parto/Vacina√ß√£o) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/categories-cards.css') }}?v={{ timestamp }}">
    <!-- CSS Filtros das categorias (chips + Ver todos) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/categories-filters.css') }}?v={{ timestamp }}">
    <!-- CSS Hospitals UX Bundle (conv√™nios chips, debug, a√ß√µes) -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hospitals-ux.css') }}?v={{ timestamp }}">
    <!-- CSS Cards de Emerg√™ncia -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/hospital-cards-emergency.css') }}?v={{ timestamp }}">
    <link rel="stylesheet" href="/static/css/debug-drawer.css?v={{ timestamp }}">
    
    <!-- Preload JavaScript cr√≠tico -->
    <!-- Removido preload de device-detector.js - n√£o necess√°rio pois √© carregado com defer -->
    <!-- chat.js n√£o precisa de preload - carrega com defer ap√≥s DOM -->
    
    <!-- Favicons -->
    <link rel="icon" type="image/svg+xml" href="{{ url_for('static', filename='favicon.svg') }}">
    <!-- Favicon.ico ser√° servido pela rota /favicon.ico (sem /static/) para evitar 404 -->
    
    <!-- CSS cr√≠tico inline para renderiza√ß√£o imediata -->
    <style>
        *{margin:0;padding:0;box-sizing:border-box}
        /* Safari/iPhone: 100dvh e -webkit-fill-available evitam corte quando a barra do Safari aparece/desaparece */
        html{
            height:100vh;
            height:100dvh;
            min-height:100%;
            min-height:-webkit-fill-available;
            overflow:hidden;
        }
        body{
            background:linear-gradient(135deg,#fff5f9 0%,#ffeef5 25%,#ffe8f0 50%,#ffd6e6 75%,#ffccd5 100%);
            margin:0;
            padding:0;
            font-family:'Playfair Display', 'Nunito', -apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,sans-serif;
            height:100vh;
            height:100dvh;
            min-height:-webkit-fill-available;
            overflow:hidden;
            color:#6b4a3f;
            -webkit-text-size-adjust:100%;
        }
        .login-screen{
            position:fixed;
            top:0;
            left:0;
            right:0;
            bottom:0;
            background:linear-gradient(135deg,#fff5f9 0%,#ffeef5 25%,#ffe8f0 50%,#ffd6e6 75%,#ffccd5 100%);
            display:flex;
            align-items:center;
            justify-content:center;
            z-index:10000
        }
        #main-container{
            display:none;
            width:100%;
            max-width:100vw;
            margin:0;
            height:100vh;
            height:100dvh;
            min-height:-webkit-fill-available;
            background:linear-gradient(135deg,#fff5f9 0%,#ffeef5 25%,#ffe8f0 50%,#ffd6e6 75%,#ffccd5 100%);
            overflow:hidden;
            position:relative;
        }
        .header-modern{
            position:sticky;
            top:0;
            background:rgba(255,255,255,0.98);
            backdrop-filter:blur(20px);
            -webkit-backdrop-filter:blur(20px);
            padding:1rem 1.5rem;
            border-bottom:1px solid rgba(244,166,166,0.15);
            z-index:1000;
            box-shadow:0 2px 8px rgba(244,166,166,0.08)
        }
        .header-modern-content{
            display:flex;
            justify-content:space-between;
            align-items:center;
            max-width:100%;
            margin:0 auto;
            padding:0 1.5rem;
        }
        .header-logo-text{
            font-family:'Playfair Display',serif;
            font-size:1.5rem;
            font-weight:700;
            color:#C44569;
            margin:0;
            letter-spacing:-0.02em
        }
        .header-icons{
            display:flex;
            gap:1rem;
            align-items:center
        }
        .header-icon-btn{
            background:transparent;
            border:none;
            color:#6B5B73;
            font-size:1.2rem;
            cursor:pointer;
            padding:0.5rem;
            border-radius:50%;
            transition:all 0.2s ease;
            width:40px;
            height:40px;
            display:flex;
            align-items:center;
            justify-content:center
        }
        .header-icon-btn:hover{
            background:rgba(244,166,166,0.1);
            color:#C44569
        }
        .container{
            width:100%;
            max-width:100vw;
            margin:0;
            height:100vh;
            height:100dvh;
            min-height:-webkit-fill-available;
            display:flex;
            flex-direction:column;
            background:linear-gradient(135deg,#fff5f9 0%,#ffeef5 25%,#ffe8f0 50%,#ffd6e6 75%,#ffccd5 100%);
            overflow:hidden;
            position:relative
        }
        .welcome-message{
            position:absolute;
            top:0;
            left:0;
            right:0;
            bottom:0;
            display:flex;
            flex-direction:column;
            align-items:center;
            justify-content:flex-start;
            background:linear-gradient(135deg,#fff5f9 0%,#ffeef5 25%,#ffe8f0 50%,#ffd6e6 75%,#ffccd5 100%);
            overflow-y:auto;
            overflow-x:hidden;
            padding:1rem 0;
            min-height:0
        }
        .welcome-content{
            text-align:center;
            padding:0.6rem 0.8rem;
            max-width:80%;
            margin:0 auto;
            width:auto;
            min-height:200px
        }
        .feature-carousel-container{
            min-height:120px;
            position:relative;
            margin:1rem auto
        }
        .feature-btn,.feeling-btn{
            min-height:44px;
            min-width:120px
        }
        .support-links{
            min-height:100px;
            margin:2.5rem auto 2rem
        }
        .medical-disclaimer{
            min-height:80px;
            margin:2rem auto
        }
        .login-container{
            background:#fff;
            border-radius:25px;
            padding:3rem;
            max-width:450px;
            width:90%;
            box-shadow:0 10px 40px rgba(255,143,163,0.3);
            box-sizing:border-box
        }
        .login-header{
            text-align:center;
            margin-bottom:2rem
        }
        .login-header h1{
            font-size:2.5rem;
            color:#8b6a5a;
            margin:0;
            font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,sans-serif
        }
        .login-content h2{
            text-align:center;
            color:#8b6a5a;
            margin-bottom:1rem
        }
    </style>
    
    <!-- Fontes Sofisticadas: Playfair Display (Serifada) + Montserrat (Sans-Serif) -->
    <link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet" media="print" onload="this.media='all';this.onload=null">
    <noscript><link href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@400;600;700&family=Montserrat:wght@300;400;500;600;700&display=swap" rel="stylesheet"></noscript>
    <style>
        /* Fallback para fontes do sistema enquanto carrega */
        body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; }
    </style>
    
    <!-- Font Awesome (carregamento otimizado - lazy load ap√≥s load da p√°gina) -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="preload" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" as="style" onload="this.onload=null;this.rel='stylesheet'">
    <noscript><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet"></noscript>
    <script>
        // Fun√ß√£o auxiliar para login (evita problemas com caracteres especiais no onclick)
        function handleLoginClick() {
            // Aguarda at√© 3 segundos para chatApp estar dispon√≠vel
            var attempts = 0;
            var maxAttempts = 30; // 30 tentativas x 100ms = 3 segundos
            
            function tryLogin() {
                if (window.chatApp && typeof window.chatApp.handleInitialLogin === 'function') {
                    console.log('‚úÖ [LOGIN] chatApp dispon√≠vel, chamando handleInitialLogin...');
                    window.chatApp.handleInitialLogin();
                    return false;
                } else if (attempts < maxAttempts) {
                    attempts++;
                    if (attempts === 1) {
                        console.log('‚è≥ [LOGIN] Aguardando chatApp estar dispon√≠vel...');
                    }
                    setTimeout(tryLogin, 100);
                } else {
                    // Aumenta timeout e tenta mais uma vez antes de mostrar erro
                    if (attempts < maxAttempts + 10) {
                        attempts++;
                        setTimeout(tryLogin, 100);
                        return false;
                    }
                    console.error('‚ùå [LOGIN] chatApp n√£o dispon√≠vel ap√≥s 4 segundos');
                    console.error('‚ùå [LOGIN] window.chatApp:', typeof window.chatApp);
                    console.error('‚ùå [LOGIN] Verifique se chat.js foi carregado corretamente');
                    // N√£o mostra alert imediatamente - d√° mais uma chance
                    setTimeout(() => {
                        if (!window.chatApp) {
                            alert('Erro: JavaScript n√£o carregou completamente. Verifique o console (F12) para mais detalhes e recarregue a p√°gina.');
                        }
                    }, 500);
                }
                return false;
            }
            
            return tryLogin();
        }
        
        // Fun√ß√£o auxiliar para registro
        function handleRegisterClick() {
            // Aguarda at√© 3 segundos para chatApp estar dispon√≠vel
            var attempts = 0;
            var maxAttempts = 30; // 30 tentativas x 100ms = 3 segundos
            
            function tryRegister() {
                if (window.chatApp && typeof window.chatApp.handleInitialRegister === 'function') {
                    console.log('‚úÖ [REGISTER] chatApp dispon√≠vel, chamando handleInitialRegister...');
                    window.chatApp.handleInitialRegister();
                    return false;
                } else if (attempts < maxAttempts) {
                    attempts++;
                    if (attempts === 1) {
                        console.log('‚è≥ [REGISTER] Aguardando chatApp estar dispon√≠vel...');
                    }
                    setTimeout(tryRegister, 100);
                } else {
                    // Fallback: faz o cadastro sem chatApp (fetch direto)
                    console.warn('‚ö†Ô∏è [REGISTER] chatApp indispon√≠vel, usando fallback direto');
                    runRegisterFallback();
                }
                return false;
            }
            
            return tryRegister();
        }
        
        // Fallback de registro quando chat.js n√£o carrega (funciona sem chatApp)
        async function runRegisterFallback() {
            var nameEl = document.getElementById('initial-register-name');
            var emailEl = document.getElementById('initial-register-email');
            var passwordEl = document.getElementById('initial-register-password');
            var babyEl = document.getElementById('initial-register-baby');
            if (!nameEl || !emailEl || !passwordEl) {
                alert('Por favor, preencha Nome, E-mail e Senha.');
                return;
            }
            var name = nameEl.value.trim();
            var email = emailEl.value.trim().toLowerCase();
            var password = passwordEl.value;
            var baby_name = (babyEl && babyEl.value) ? babyEl.value.trim() : '';
            if (!name || !email || !password) {
                alert('Por favor, preencha os campos obrigat√≥rios! üíï');
                return;
            }
            if (password.length < 6) {
                alert('A senha deve ter no m√≠nimo 6 caracteres! üíï');
                return;
            }
            try {
                var response = await fetch('/api/register', {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name: name, email: email, password: password, baby_name: baby_name})
                });
                var data = await response.json();
                if (response.ok && data.sucesso !== false) {
                    alert('üéâ ' + (data.mensagem || 'Cadastro realizado!'));
                    var loginTab = document.querySelector('[data-tab="login"]');
                    if (loginTab) loginTab.click();
                    var loginEmail = document.getElementById('initial-login-email');
                    if (loginEmail) loginEmail.value = email;
                } else {
                    var msg = data.erro || data.mensagem || 'Erro ao cadastrar. Tente novamente.';
                    alert('‚ö†Ô∏è ' + msg);
                }
            } catch (e) {
                console.error('Erro no registro:', e);
                alert('Erro ao cadastrar. Verifique sua conex√£o e tente novamente.');
            }
        }
        
        // Fallback para carregar Font Awesome se onload n√£o funcionar
        (function() {
            var link = document.querySelector('link[href*="font-awesome"]');
            if (link && link.rel === 'preload') {
                setTimeout(function() {
                    if (link.rel === 'preload') {
                        link.rel = 'stylesheet';
                    }
                }, 100);
            }
        })();
        
        // Configura√ß√£o de fallbacks para recursos minificados
        // URLs s√£o lidas de um elemento JSON separado (gerado pelo Jinja2)
        (function() {
            function setupFallbacks() {
                var configElement = document.getElementById('app-config');
                if (!configElement) return;
                
                try {
                    var config = JSON.parse(configElement.textContent);
                    if (!config.fallbacks) return;
                    
                    // Fallback para CSS
                    var cssLink = document.querySelector('link[href*="style.min.css"]');
                    if (cssLink && config.fallbacks.css) {
                        cssLink.addEventListener('error', function() {
                            this.onerror = null;
                            this.href = config.fallbacks.css;
                            this.rel = 'stylesheet';
                        });
                    }
                    
                    // Fallback para JS
                    var jsScript = document.querySelector('script[src*="chat.min.js"]');
                    if (jsScript && config.fallbacks.js) {
                        jsScript.addEventListener('error', function() {
                            this.onerror = null;
                            this.src = config.fallbacks.js;
                        });
                    }
                } catch (e) {
                    console.warn('Erro ao carregar configura√ß√£o de fallbacks:', e);
                }
            }
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', setupFallbacks);
            } else {
                setupFallbacks();
            }
        })();
    </script>
</head>
<body>
    <!-- Login Screen (shown first) -->
    <div class="login-screen" id="login-screen">
        <div class="login-container">
            <div class="login-header">
                <i class="fas fa-heart"></i>
                <h1>Sophia üíï</h1>
                <span class="login-subtitle">Sua Companheira no Puerp√©rio</span>
            </div>
            <div class="login-content">
                <h2 class="login-welcome-title">Bem-vinda √† Sophia - Sua Companheira no Puerp√©rio! üëã</h2>
                <p style="color: #8b5a5a; margin-bottom: 2rem;">Fa√ßa login ou crie sua conta para come√ßar</p>
                {% if login_error %}
                <p class="login-error-banner" style="background:#fef2f2;color:#991b1b;padding:0.75rem;border-radius:6px;margin-bottom:1rem;font-weight:600;">
                    Email ou senha incorretos. Tente novamente.
                </p>
                {% endif %}
                <div class="login-forms">
                    <!-- Fallback sem JS: action + method garantem submit no servidor se JS cair -->
                    <form class="login-form active" id="initial-login-form" action="/auth/login" method="POST">
                        <div class="form-group">
                            <label for="initial-login-email">
                                <i class="fas fa-envelope"></i>
                                E-mail
                            </label>
                            <input type="email" id="initial-login-email" name="email" autocomplete="email" placeholder="Seu e-mail" required>
                        </div>
                        <div class="form-group">
                            <label for="initial-login-password">
                                <i class="fas fa-lock"></i>
                                Senha
                            </label>
                            <input type="password" id="initial-login-password" name="password" autocomplete="current-password" placeholder="Sua senha" required>
                        </div>
                        <div class="form-group remember-me-group">
                            <label class="remember-me-label">
                                <input type="checkbox" id="initial-remember-me" name="remember_me" value="1" checked>
                                <span class="remember-me-text">
                                    <i class="fas fa-heart"></i>
                                    Lembre-se de mim
                                </span>
                            </label>
                        </div>
                        <div class="login-actions-stack">
                        <button type="submit" class="btn btn-login-main btn-login-block" id="initial-login-submit">
                            <i class="fas fa-sign-in-alt"></i>
                            <span class="btn-login-text">Entrar</span>
                        </button>
                        <a href="/forgot-password" class="forgot-password-link" id="forgot-password-link">
                            <i class="fas fa-key"></i>
                            Esqueci minha senha
                        </a>
                        <a href="#" class="forgot-password-link resend-verification-link" id="resend-verification-link" style="display:block;margin-top:0.5rem;font-size:0.9em;">
                            <i class="fas fa-envelope"></i>
                            Reenviar link de verifica√ß√£o
                        </a>
                        </div>
                        <p class="login-switch-link">
                            Novo por aqui? <button type="button" class="link-button" data-tab="register" aria-label="Ir para cadastro">Cadastre-se aqui</button>
                        </p>
                    </form>
                    
                    <form class="login-form" id="initial-register-form" onsubmit="return false;" action="javascript:void(0);">
                        <div class="form-group">
                            <label for="initial-register-name">
                                <i class="fas fa-user"></i>
                                Nome
                            </label>
                            <input type="text" id="initial-register-name" name="name" autocomplete="name" placeholder="Seu nome" required>
                        </div>
                        <div class="form-group">
                            <label for="initial-register-email">
                                <i class="fas fa-envelope"></i>
                                E-mail
                            </label>
                            <input type="email" id="initial-register-email" name="register_email" autocomplete="new-password" placeholder="E-mail novo" required>
                        </div>
                        <div class="form-group">
                            <label for="initial-register-password">
                                <i class="fas fa-lock"></i>
                                Senha
                            </label>
                            <input type="password" id="initial-register-password" name="password" autocomplete="new-password" placeholder="Senha (m√≠n. 6)" required>
                        </div>
                        <div class="form-group">
                            <label for="initial-register-baby">
                                <i class="fas fa-baby"></i>
                                Nome do beb√™ (opcional)
                            </label>
                            <input type="text" id="initial-register-baby" name="baby_name" autocomplete="off" placeholder="Nome do beb√™ (opcional)">
                        </div>
                        <button type="button" class="btn btn-login-main btn-login-block" id="initial-register-submit" onclick="return handleRegisterClick();">
                            <i class="fas fa-user-plus"></i>
                            <span class="btn-login-text">Criar Conta</span>
                        </button>
                        <p class="login-switch-link">
                            J√° tem conta? <button type="button" class="link-button" data-tab="login" aria-label="Ir para login">Entre aqui</button>
                        </p>
                    </form>
                </div>
            </div>
        </div>
    </div>
    
    <div class="container" id="main-container" style="display: none;">
        <!-- Header Moderno - Redesign -->
        <header class="header-modern">
            <div class="header-modern-content">
                <!-- Lado Esquerdo: Menu Hamb√∫rguer + Logo -->
                <div class="header-left">
                    <button type="button" class="header-icon-btn" id="menu-toggle-header" aria-label="Abrir menu" onclick="if(window.chatApp)window.chatApp.toggleSidebar(); return false;">
                        <i class="fas fa-bars"></i>
                    </button>
                    <div class="header-logo">
                        <h1 class="header-logo-text">Sophia</h1>
                    </div>
                </div>
                <!-- Lado Direito: Perfil -->
                <div class="header-right">
                    <button class="header-icon-btn" id="header-profile-btn" aria-label="Perfil">
                        <i class="fas fa-user"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Chat Container -->
        <div class="chat-container">
            <!-- Sidebar -->
            <div class="sidebar" id="sidebar">
                <div class="sidebar-header">
                    <h2><i class="fas fa-heart"></i> Menu R√°pido</h2>
                    <button class="close-sidebar" id="close-sidebar" aria-label="Fechar menu">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="sidebar-content">
                    <div class="sidebar-section">
                        <h4>üìö Recursos √öteis</h4>
                        <button class="sidebar-btn" id="sidebar-btn-guias">
                            <i class="fas fa-book-medical"></i>
                            Guias Pr√°ticos
                        </button>
                        <button class="sidebar-btn" id="sidebar-btn-gestacao">
                            <i class="fas fa-heart"></i>
                            Cuidados Gesta√ß√£o
                        </button>
                        <button class="sidebar-btn" id="sidebar-btn-posparto">
                            <i class="fas fa-baby"></i>
                            Cuidados P√≥s-Parto
                        </button>
                        <button class="sidebar-btn" id="sidebar-btn-vacinas">
                            <i class="fas fa-syringe"></i>
                            Vacina√ß√£o
                        </button>
                    </div>
                    
                    <div class="sidebar-section">
                        <h4>üíù Apoio e Sa√∫de</h4>
                        <button class="sidebar-btn" id="sidebar-btn-sintomas">
                            <i class="fas fa-exclamation-triangle"></i>
                            Sinais de Alerta
                        </button>
                        <div class="sidebar-contact-emergency">
                            <button class="emergency-btn" id="btn-emergency-numbers">
                                <i class="fas fa-phone-alt"></i>
                                <span>N√∫meros de Emerg√™ncia</span>
                            </button>
                        </div>
                    </div>
                    
                    <div class="sidebar-section">
                        <h4>‚ö° A√ß√µes R√°pidas</h4>
                        <button class="sidebar-btn" id="sidebar-btn-clear">
                            <i class="fas fa-trash"></i>
                            Limpar Hist√≥rico
                        </button>
                        <button class="sidebar-btn" id="sidebar-btn-clear-memory">
                            <i class="fas fa-brain"></i>
                            Limpar Mem√≥ria da Sophia
                        </button>
                        <button class="sidebar-btn" id="sidebar-btn-back">
                            <i class="fas fa-home"></i>
                            Voltar ao Menu
                        </button>
                    </div>
                    
                    <div class="sidebar-section">
                        <h4>üë§ Minha Conta</h4>
                        <button class="sidebar-btn sidebar-btn-logout" id="sidebar-btn-logout">
                            <i class="fas fa-sign-out-alt"></i>
                            Sair da Conta
                        </button>
                    </div>
                </div>
            </div>

            <!-- Chat Area -->
            <div class="chat-area">
                <!-- Chat Header Fixo (Desktop) -->
                <div class="chat-header-fixed" id="chat-header-fixed" style="display: none;">
                    <div class="chat-header-content">
                    <div class="chat-header-info">
                        <span class="chat-header-icon">üí¨</span>
                        <div class="chat-header-text">
                            <h3>
                                <span class="sophia-status-indicator"></span>
                                Conversando com Sophia
                            </h3>
                            <p class="chat-header-subtitle" id="chat-header-subtitle">Apoio para a mam√£e</p>
                        </div>
                    </div>
                    </div>
                </div>
                <!-- Welcome Message -->
                <div class="welcome-message" id="welcome-message">
                    <!-- Layout de 3 colunas (Desktop ‚â•1024px) -->
                    <!-- Sidebar Esquerda -->
                    <div class="desktop-sidebar desktop-sidebar-left">
                        <div class="desktop-side-decorations">
                            <div class="floating-icon icon-1" aria-hidden="true">üíï</div>
                            <div class="floating-icon icon-2" aria-hidden="true">üå∏</div>
                            <div class="floating-icon icon-3" aria-hidden="true">ü§±</div>
                            <div class="decoration-shape shape-1"></div>
                            <div class="decoration-shape shape-2"></div>
                        </div>

                        <!-- Espa√ßo reservado para conte√∫do adicional na sidebar -->
                    </div>
                    
                    <!-- Conte√∫do Central -->
                    <div class="welcome-content-wrapper">
                        <!-- Elementos decorativos de fundo (mantidos para compatibilidade) -->
                        <div class="decorative-elements">
                            <div class="decorative-icon icon-1"><i class="fas fa-heart"></i></div>
                            <div class="decorative-icon icon-2"><i class="fas fa-baby"></i></div>
                            <div class="decorative-icon icon-3"><i class="fas fa-hands-helping"></i></div>
                            <div class="decorative-icon icon-4"><i class="fas fa-leaf"></i></div>
                        </div>
                        
                        <div class="welcome-content">
                        <div class="welcome-icon-wrapper">
                            <i class="fas fa-heart welcome-hero-icon"></i>
                            <div class="icon-glow"></div>
                        </div>
                        <h2 class="welcome-hero-title">Sophia - Sua Companheira no Puerp√©rio üíõ</h2>
                        <p class="welcome-hero-subtitle">Aqui cuidamos de voc√™, enquanto voc√™ cuida do seu beb√™.</p>
                        <p class="inclusion-phrase">Cada jornada √© √∫nica ‚Äî e todas merecem acolhimento. üåº</p>
                        <p class="welcome-hero-description">Ol√°! Sou a Sophia, sua companheira no puerp√©rio. Estou aqui para te acompanhar durante essa fase especial. Como posso te ajudar hoje? ü§±</p>
                        
                        <!-- Bot√£o Principal: Conversar com a Sophia -->
                        <div class="start-chat-container">
                            <button class="btn btn-start-chat" id="start-chat-btn">
                                <i class="fas fa-comments"></i>
                                <span>Conversar com a Sophia üí¨</span>
                            </button>
                        </div>
                        
                        <!-- Hero Grid - Menu Principal (2x2 Mobile / 4x1 Desktop) -->
                        <div class="hero-grid-section" data-viewall-href="/conteudos">
                            <div class="hero-grid">
                                <button class="hero-grid-card" id="btn-guias">
                                    <i class="fa-solid fa-book-open-reader"></i>
                                    <span class="hero-card-text">Guias Pr√°ticos</span>
                                </button>
                                <button class="hero-grid-card" id="btn-gestacao">
                                    <i class="fa-solid fa-person-pregnant"></i>
                                    <span class="hero-card-text">Gesta√ß√£o</span>
                                </button>
                                <button class="hero-grid-card" id="btn-posparto">
                                    <i class="fa-solid fa-baby-carriage"></i>
                                    <span class="hero-card-text">P√≥s-Parto</span>
                                </button>
                                <button class="hero-grid-card" id="btn-vacinas">
                                    <i class="fa-solid fa-syringe"></i>
                                    <span class="hero-card-text">Vacina√ß√£o</span>
                                </button>
                            </div>
                        </div>
                        
                        <!-- Conte√∫dos Educativos: lista vertical (n√£o carrossel) -->
                        <div class="conteudos-educativos-section-modern conteudos-educativos-list">
                            <h2 class="conteudos-title-modern">üìö Conte√∫dos Educativos</h2>
                            <div class="conteudos-carousel conteudos-educativos-list-inner" data-viewall-href="/conteudos">
                                <div class="conteudos-carousel-track card-container">
                                    <!-- C√¢ncer de Mama -->
                                    <div class="conteudo-card-carousel" id="card-cancer-mama-welcome">
                                        <div class="conteudo-card-figure">
                                            <img class="edu-img" src="{{ url_for('static', filename='img/edu/cancer-mama.png') }}" alt="C√¢ncer de Mama" loading="lazy">
                                        </div>
                                        <h3 class="conteudo-card-title">C√¢ncer de Mama</h3>
                                        <a class="conteudo-card-cta btn-soft" href="https://www.gov.br/saude/pt-br/assuntos/saude-de-a-a-z/c/cancer-de-mama" target="_blank" rel="noopener noreferrer" aria-label="Acessar informa√ß√µes sobre c√¢ncer de mama no Minist√©rio da Sa√∫de">
                                            <i class="fas fa-external-link-alt"></i>
                                            Minist√©rio da Sa√∫de
                                        </a>
                                    </div>
                                    <!-- Doa√ß√£o de Leite -->
                                    <div class="conteudo-card-carousel" id="card-doacao-leite-welcome">
                                        <div class="conteudo-card-figure">
                                            <img class="edu-img" src="{{ url_for('static', filename='img/edu/doacao-leite-materno.png') }}" alt="Doa√ß√£o de Leite Materno" loading="lazy">
                                        </div>
                                        <h3 class="conteudo-card-title">Doa√ß√£o de Leite</h3>
                                        <a class="conteudo-card-cta btn-soft" href="https://www.gov.br/saude/pt-br/assuntos/saude-de-a-a-z/d/doacao-de-leite" target="_blank" rel="noopener noreferrer" aria-label="Acessar informa√ß√µes sobre doa√ß√£o de leite no Minist√©rio da Sa√∫de">
                                            <i class="fas fa-external-link-alt"></i>
                                            Minist√©rio da Sa√∫de
                                        </a>
                                    </div>
                                    <!-- Amamenta√ß√£o -->
                                    <div class="conteudo-card-carousel" id="card-aleitamento">
                                        <div class="conteudo-card-figure">
                                            <img class="edu-img" src="{{ url_for('static', filename='img/edu/aleitamento.png') }}" alt="Amamenta√ß√£o" loading="lazy">
                                        </div>
                                        <h3 class="conteudo-card-title">Amamenta√ß√£o</h3>
                                        <a class="conteudo-card-cta btn-soft" href="https://www.gov.br/saude/pt-br/assuntos/saude-de-a-a-z/a/aleitamento-materno" target="_blank" rel="noopener noreferrer" aria-label="Acessar informa√ß√µes sobre aleitamento materno no Minist√©rio da Sa√∫de">
                                            <i class="fas fa-external-link-alt"></i>
                                            Minist√©rio da Sa√∫de
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Espa√ßo de Escuta -->
                        <div class="feeling-box">
                            <h2 class="gentle-title">Como est√° seu cora√ß√£o hoje?</h2>
                            <p class="gentle-subtitle">Escolha a palavra que melhor te acolhe agora.</p>
                            <div class="feeling-buttons-grid">
                                <button class="feeling-btn" data-feeling="cansada" aria-label="Estou exausta">Exausta</button>
                                <button class="feeling-btn" data-feeling="feliz" aria-label="Estou em paz">Em paz</button>
                                <button class="feeling-btn" data-feeling="ansiosa" aria-label="Estou sobrecarregada">Sobrecarregada</button>
                                <button class="feeling-btn" data-feeling="confusa" aria-label="Estou confusa">Confusa</button>
                                <button class="feeling-btn" data-feeling="triste" aria-label="Estou para baixo">Para baixo</button>
                                <button class="feeling-btn" data-feeling="gratidao" aria-label="Estou grata">Grata</button>
                            </div>
                            <div class="feeling-feedback" id="feeling-feedback" style="display: none;">
                                <span class="feeling-feedback-icon">üíó</span>
                                <span class="feeling-feedback-text">Obrigada por compartilhar</span>
                            </div>
                        </div>
                        
                        <!-- B√∫ssola de Sentimentos: fundo branco expl√≠cito -->
                        <div class="quick-questions feeling-box quick-questions-section-white">
                            <h2 class="gentle-title">N√£o sabe por onde come√ßar?</h2>
                            <p class="gentle-subtitle">Clique em uma frase para iniciar a conversa:</p>
                            <div class="quick-questions-grid feeling-buttons-grid">
                                <button class="quick-btn feeling-btn" data-feeling="frase" data-question="Tudo parece muito dif√≠cil hoje.">Tudo parece muito dif√≠cil hoje.</button>
                                <button class="quick-btn feeling-btn" data-feeling="frase" data-question="Sinto uma tristeza que n√£o passa.">Sinto uma tristeza que n√£o passa.</button>
                                <button class="quick-btn feeling-btn" data-feeling="frase" data-question="Esqueci como cuidar de mim mesma.">Esqueci como cuidar de mim mesma.</button>
                                <button class="quick-btn feeling-btn" data-feeling="frase" data-question="Estou com dificuldades para amamentar.">Estou com dificuldades para amamentar.</button>
                                <button class="quick-btn feeling-btn" data-feeling="frase" data-question="Sinto coisas estranhas no meu corpo/mente.">Sinto coisas estranhas no meu corpo/mente.</button>
                                <button class="quick-btn feeling-btn" data-feeling="frase" data-question="N√£o sei explicar o que estou sentindo.">N√£o sei explicar o que estou sentindo.</button>
                            </div>
                        </div>
                        
                        <!-- Cards de Apoio (Orienta√ß√£o, Afirma√ß√£o e Agenda de Vacina√ß√£o) -->
                        <div class="welcome-cards-container" id="welcome-cards-container">
                            <!-- Card Orienta√ß√£o -->
                            <div class="sidebar-card orientacao-card" id="orientacao-card" role="button" tabindex="0" aria-label="Clique para ver outra orienta√ß√£o">
                                <div class="card-icon"><i class="fas fa-tint" aria-hidden="true"></i></div>
                                <h3>Orienta√ß√£o</h3>
                                <div class="orientacao-content" id="orientacao-content">
                                    <p class="orientacao-text" id="orientacao-text">Carregando orienta√ß√£o...</p>
                                </div>
                            </div>
                            
                            <!-- Card Afirma√ß√£o Positiva -->
                            <div class="sidebar-card affirmation-card" id="affirmation-card" role="button" tabindex="0" aria-label="Clique para ver outra afirma√ß√£o">
                                <div class="card-icon"><i class="fas fa-sun" aria-hidden="true"></i></div>
                                <h3>Afirma√ß√£o</h3>
                                <div class="affirmation-content" id="affirmation-content">
                                    <p class="affirmation-text" id="affirmation-text">Carregando afirma√ß√£o...</p>
                                </div>
                            </div>
                            
                            <!-- Card Agenda de Vacina√ß√£o -->
                            <div class="sidebar-card agenda-card" id="agenda-de-vacinacao-card">
                                <div class="card-icon"><i class="fas fa-calendar-check" aria-hidden="true"></i></div>
                                <h3>Agenda de Vacina√ß√£o</h3>
                                <div class="agenda-content" id="agenda-content">
                                    <p class="agenda-text" id="agenda-text">Carregando agenda...</p>
                                </div>
                                <div class="agenda-reminders-wrap" id="agenda-reminders-wrap" style="margin-top: 0.75rem; width: 100%; text-align: left;"></div>
                                <button type="button" class="btn-agenda-add-reminder" id="btn-add-reminder" style="margin-top: 0.5rem; padding: 0.5rem 0.75rem; border-radius: 12px; border: 1px solid rgba(244,166,166,0.5); background: rgba(255,255,255,0.9); color: #8b5a5a; font-size: 0.9rem; cursor: pointer;">
                                    <i class="fas fa-plus" aria-hidden="true"></i> Adicionar lembrete
                                </button>
                            </div>
                        </div>
                        
                        <!-- Mensagem Rotativa de Apoio -->
                        <div class="rotating-message">
                            <p id="rotating-text">Voc√™ n√£o est√° sozinha. üíõ</p>
                        </div>
                        
                        <!-- Aviso Importante (accordion no final, n√£o rouba protagonismo) -->
                        <div class="medical-disclaimer medical-disclaimer-accordion medical-disclaimer-end">
                            <button type="button" class="medical-disclaimer-toggle" id="medical-disclaimer-toggle" aria-expanded="false" aria-controls="medical-disclaimer-content">
                                <i class="fas fa-exclamation-triangle"></i>
                                <span>Aviso Importante</span>
                                <i class="fas fa-chevron-down accordion-arrow"></i>
                            </button>
                            <div class="medical-disclaimer-content" id="medical-disclaimer-content" hidden>
                                <p class="disclaimer-text">
                                    Este conte√∫do √© apenas informativo e n√£o substitui uma consulta m√©dica profissional. 
                                    Procure orienta√ß√£o m√©dica ou de enfermagem antes de usar qualquer medicamento, suplemento ou vitamina. 
                                    Sempre consulte um m√©dico, enfermeiro ou profissional de sa√∫de qualificado para orienta√ß√µes personalizadas. 
                                    Em situa√ß√µes de emerg√™ncia, gestantes e pu√©rperas devem procurar imediatamente um hospital com emerg√™ncia obst√©trica, onde h√° equipe especializada 24h. 
                                    Para outras emerg√™ncias, ligue para <strong>192 (SAMU)</strong>.
                                </p>
                            </div>
                        </div>

                        <!-- Container da Timeline de Vacina√ß√£o -->
                        <div id="vaccination-timeline-container" style="display: none;">
                            <!-- Timeline ser√° renderizada via JavaScript -->
                        </div>
                        </div>
                    </div>
                    
                    <!-- Sidebar Direita -->
                    <div class="desktop-sidebar desktop-sidebar-right">
                        <div class="desktop-side-decorations">
                            <div class="floating-icon icon-4" aria-hidden="true">‚ú®</div>
                            <div class="floating-icon icon-5" aria-hidden="true">üåô</div>
                            <div class="floating-icon icon-6" aria-hidden="true">üí´</div>
                            <div class="decoration-shape shape-3"></div>
                            <div class="decoration-shape shape-4"></div>
                        </div>
                    </div>
                    
                    <!-- Modal de V√≠deo -->
                    <div class="video-modal" id="video-modal" style="display: none;">
                        <div class="video-modal-overlay" id="video-modal-overlay"></div>
                        <div class="video-modal-content">
                            <button class="video-modal-close" id="video-modal-close" aria-label="Fechar v√≠deo">
                                <i class="fas fa-times"></i>
                            </button>
                            <div class="video-modal-player" id="video-modal-player">
                                <!-- Player ser√° inserido aqui -->
                            </div>
                            <div class="video-modal-info" id="video-modal-info">
                                <h4 id="video-modal-title"></h4>
                                <p id="video-modal-description"></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Chat Messages -->
                <div class="chat-messages" id="chat-messages">
                    <!-- Messages will be added here dynamically -->
                </div>

                <!-- Back to Welcome Button -->
                <div class="back-to-welcome" id="back-to-welcome" style="display: none;">
                    <button class="btn btn-secondary" id="back-btn">
                        <i class="fas fa-home"></i>
                        üè† Voltar ao Menu
                    </button>
                </div>

            </div>
        </div>

        <!-- Input Area -->
        <div class="input-area" data-form-type="chat" style="display: none;">
            <!-- Typing Indicator - Acima do bot√£o de enviar -->
            <div class="typing-indicator" id="typing-indicator">
                <div class="typing-dots">
                    <span></span>
                    <span></span>
                    <span></span>
                </div>
            </div>
            <div class="input-container">
                <button class="btn btn-icon" id="menu-toggle" aria-label="Abrir menu">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="input-wrapper">
                    <input type="text" id="message-input" name="chat-message" placeholder="Digite sua pergunta sobre puerp√©rio..." maxlength="2000" autocomplete="off" autocorrect="off" autocapitalize="sentences" spellcheck="true" inputmode="text" data-lpignore="true" data-form-type="other" role="textbox" aria-label="Campo de mensagem do chat">
                    <button class="btn btn-send" id="send-button" aria-label="Enviar mensagem">
                        <i class="fas fa-paper-plane"></i>
                    </button>
                </div>
                <div class="input-info">
                    <span id="char-count">0/2000</span>
                </div>
            </div>
        </div>

        <!-- Auth Modal (Login/Cadastro) -->
        <div class="modal" id="auth-modal">
            <div class="modal-content modal-auth">
                <div class="modal-header">
                    <h2><i class="fas fa-heart"></i> Acesso ao Sophia üíï</h2>
                    <button class="close-modal" id="close-auth" aria-label="Fechar modal de autentica√ß√£o">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Login Form -->
                    <div class="auth-form active" id="login-form">
                        <div class="form-group">
                            <label for="login-email"><i class="fas fa-envelope"></i> E-mail</label>
                            <input type="email" id="login-email" name="email" autocomplete="email" placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label for="login-password"><i class="fas fa-lock"></i> Senha</label>
                            <input type="password" id="login-password" name="password" autocomplete="current-password" placeholder="Sua senha">
                        </div>
                        <div class="form-group remember-me-group">
                            <label class="remember-me-label">
                                <input type="checkbox" id="remember-me" name="remember_me" checked>
                                <span class="remember-me-text">
                                    <i class="fas fa-heart"></i>
                                    Lembre-se de mim
                                </span>
                            </label>
                        </div>
                        <button class="btn btn-primary btn-full" id="btn-login">
                            <i class="fas fa-heart"></i> Entrar na minha conta
                        </button>
                        <p class="auth-link">N√£o tem conta? <a href="#" id="show-register">Cadastre-se aqui</a></p>
                    </div>

                    <!-- Register Form -->
                    <div class="auth-form" id="register-form">
                        <div class="form-group">
                            <label for="register-name"><i class="fas fa-user"></i> Nome</label>
                            <input type="text" id="register-name" name="name" autocomplete="name" placeholder="Seu nome">
                        </div>
                        <div class="form-group">
                            <label for="register-email"><i class="fas fa-envelope"></i> E-mail</label>
                            <input type="email" id="register-email" name="email" autocomplete="email" placeholder="seu@email.com">
                        </div>
                        <div class="form-group">
                            <label for="register-password"><i class="fas fa-lock"></i> Senha</label>
                            <input type="password" id="register-password" name="password" autocomplete="new-password" placeholder="M√≠nimo 6 caracteres">
                        </div>
                        <div class="form-group">
                            <label for="register-baby"><i class="fas fa-baby"></i> Nome do beb√™ (opcional)</label>
                            <input type="text" id="register-baby" name="baby_name" autocomplete="off" placeholder="Nome do seu beb√™">
                        </div>
                        <button class="btn btn-primary btn-full" id="btn-register">
                            <i class="fas fa-heart"></i> Criar conta
                        </button>
                        <p class="auth-link">J√° tem conta? <a href="#" id="show-login">Entre aqui</a></p>
                    </div>
                </div>
            </div>
        </div>

    <!-- Modal Adicionar Lembrete de Vacina√ß√£o -->
    <div class="modal" id="vaccination-reminder-modal" style="display: none;">
        <div class="modal-content" style="max-width: 420px; border-radius: 20px; background: linear-gradient(135deg, #f0f8ff 0%, #e8f4fc 100%); box-shadow: 0 10px 40px rgba(144,202,249,0.25);">
            <div class="modal-header" style="border-bottom: 1px solid rgba(244,166,166,0.3);">
                <h3 style="color: #8b5a5a; font-size: 1.2rem;"><i class="fas fa-calendar-plus"></i> Adicionar lembrete</h3>
                <button type="button" class="close-modal" id="close-vaccination-reminder-modal" aria-label="Fechar">&times;</button>
            </div>
            <div class="modal-body" style="padding: 1.25rem;">
                <form id="form-vaccination-reminder">
                    <label for="reminder-vacina" style="display:block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #6b4a3f;">Vacina</label>
                    <input type="text" id="reminder-vacina" name="vacina" required placeholder="Ex.: BCG, Hepatite B" style="width: 100%; padding: 0.5rem 0.75rem; border-radius: 12px; border: 1px solid rgba(244,166,166,0.4); margin-bottom: 0.75rem; box-sizing: border-box;">
                    <label for="reminder-data" style="display:block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #6b4a3f;">Data</label>
                    <input type="date" id="reminder-data" name="data" required style="width: 100%; padding: 0.5rem 0.75rem; border-radius: 12px; border: 1px solid rgba(244,166,166,0.4); margin-bottom: 0.75rem; box-sizing: border-box;">
                    <label for="reminder-hora" style="display:block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #6b4a3f;">Hora</label>
                    <input type="time" id="reminder-hora" name="hora" placeholder="Ex.: 14:00" style="width: 100%; padding: 0.5rem 0.75rem; border-radius: 12px; border: 1px solid rgba(244,166,166,0.4); margin-bottom: 0.75rem; box-sizing: border-box;">
                    <label for="reminder-local" style="display:block; margin-bottom: 0.25rem; font-size: 0.9rem; color: #6b4a3f;">Local</label>
                    <input type="text" id="reminder-local" name="local" required placeholder="Ex.: UBS Centro, Hospital X" style="width: 100%; padding: 0.5rem 0.75rem; border-radius: 12px; border: 1px solid rgba(244,166,166,0.4); margin-bottom: 1rem; box-sizing: border-box;">
                    <div style="display: flex; gap: 0.75rem; justify-content: flex-end;">
                        <button type="button" class="btn btn-secondary" id="cancel-vaccination-reminder" style="padding: 0.5rem 1rem; border-radius: 12px;">Cancelar</button>
                        <button type="submit" class="btn btn-primary" id="submit-vaccination-reminder" style="padding: 0.5rem 1rem; border-radius: 12px; background: #f4a6a6;">Salvar</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Logout Confirmation Modal -->
    <div class="modal" id="logout-confirm-modal" style="display: none;">
        <div class="modal-content" style="max-width: 400px;">
            <div class="modal-header">
                <h3>Sair da Conta?</h3>
                <button class="close-modal" id="close-logout-confirm" aria-label="Fechar">&times;</button>
            </div>
            <div class="modal-body" style="text-align: center; padding: 2rem;">
                <p style="color: #8b5a5a; font-size: 1.1rem; margin-bottom: 2rem;">
                    Tem certeza de que deseja sair da sua conta? üíï
                </p>
                <div style="display: flex; gap: 1rem; justify-content: center; flex-wrap: wrap;">
                    <button class="btn btn-secondary" id="logout-cancel-btn" style="min-width: 160px !important; min-height: 50px !important; border-radius: 8px !important; padding: 1rem 2rem !important; font-size: 0.95rem !important; white-space: nowrap !important; display: flex !important; align-items: center !important; justify-content: center !important; text-align: center !important; line-height: 1.2 !important;">
                        Cancelar
                    </button>
                    <button class="btn btn-primary" id="logout-confirm-btn" style="min-width: 160px !important; min-height: 50px !important; border-radius: 8px !important; padding: 1rem 2rem !important; font-size: 0.95rem !important; background: #f4a6a6 !important; white-space: nowrap !important; display: flex !important; align-items: center !important; justify-content: center !important; text-align: center !important; line-height: 1.2 !important;">
                        Sim, Sair
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Baby Profile Onboarding Modal -->
    <div class="modal" id="baby-profile-modal" style="display: none;">
        <div class="modal-content" style="max-width: 500px; background: linear-gradient(135deg, #fff5f9 0%, #ffeef5 100%); border-radius: 20px; box-shadow: 0 10px 40px rgba(255, 182, 193, 0.3);">
            <div class="modal-header" style="background: transparent; border-bottom: 2px solid #ffccd5; padding: 1.5rem;">
                <h2 style="color: #8b5a5a; font-family: 'Playfair Display', serif; font-size: 1.5rem; margin: 0; text-align: center;">
                    <i class="fas fa-heart" style="color: #ff8fa3;"></i> Ol√°! A Sophia quer te conhecer melhor. üíï
                </h2>
                <button class="close-modal" id="close-baby-profile" aria-label="Fechar modal" style="display: none;">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body" style="padding: 2rem;">
                <p style="color: #6b4a3f; font-size: 1rem; line-height: 1.6; margin-bottom: 2rem; text-align: center;">
                    Para eu acompanhar o desenvolvimento e as vacinas do seu beb√™, me conte um pouquinho sobre ele(a):
                </p>
                <form id="baby-profile-form" style="display: flex; flex-direction: column; gap: 1.5rem;">
                    <div class="form-group" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label for="baby-name-input" style="color: #8b5a5a; font-weight: 600; font-size: 0.95rem;">
                            <i class="fas fa-baby" style="color: #ff8fa3; margin-right: 0.5rem;"></i>
                            Qual o nome do seu beb√™?
                        </label>
                        <input 
                            type="text" 
                            id="baby-name-input" 
                            name="name" 
                            placeholder="Ex: Maria, Jo√£o, Sofia..." 
                            required
                            autocomplete="off"
                            style="padding: 0.875rem; border: 2px solid #ffccd5; border-radius: 12px; font-size: 1rem; color: #6b4a3f; background: white; transition: all 0.3s ease;"
                            onfocus="this.style.borderColor='#ff8fa3'; this.style.boxShadow='0 0 0 3px rgba(255, 143, 163, 0.1)';"
                            onblur="this.style.borderColor='#ffccd5'; this.style.boxShadow='none';"
                        >
                    </div>
                    <div class="form-group" style="display: flex; flex-direction: column; gap: 0.5rem;">
                        <label for="baby-birth-date-input" style="color: #8b5a5a; font-weight: 600; font-size: 0.95rem;">
                            <i class="fas fa-calendar-heart" style="color: #ff8fa3; margin-right: 0.5rem;"></i>
                            Quando ele(a) nasceu?
                        </label>
                        <input 
                            type="date" 
                            id="baby-birth-date-input" 
                            name="birth_date" 
                            required
                            max=""
                            style="padding: 0.875rem; border: 2px solid #ffccd5; border-radius: 12px; font-size: 1rem; color: #6b4a3f; background: white; transition: all 0.3s ease;"
                            onfocus="this.style.borderColor='#ff8fa3'; this.style.boxShadow='0 0 0 3px rgba(255, 143, 163, 0.1)';"
                            onblur="this.style.borderColor='#ffccd5'; this.style.boxShadow='none';"
                        >
                    </div>
                    <div id="baby-profile-error" style="display: none; color: #d32f2f; background: #ffebee; padding: 0.75rem; border-radius: 8px; font-size: 0.9rem; margin-top: -0.5rem;"></div>
                    <button 
                        type="submit" 
                        id="baby-profile-submit-btn"
                        style="background: linear-gradient(135deg, #ff8fa3 0%, #ffb3c1 100%); color: white; border: none; padding: 1rem 2rem; border-radius: 12px; font-size: 1.1rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; box-shadow: 0 4px 15px rgba(255, 143, 163, 0.3); margin-top: 0.5rem;"
                        onmouseover="this.style.transform='translateY(-2px)'; this.style.boxShadow='0 6px 20px rgba(255, 143, 163, 0.4)';"
                        onmouseout="this.style.transform='translateY(0)'; this.style.boxShadow='0 4px 15px rgba(255, 143, 163, 0.3)';"
                    >
                        <i class="fas fa-heart" style="margin-right: 0.5rem;"></i>
                        Salvar e Come√ßar
                    </button>
                </form>
            </div>
        </div>
    </div>

    <!-- Alert Modal -->
    <div class="modal" id="alert-modal">
        <div class="modal-content">
                <div class="modal-header">
                    <h2><i class="fas fa-exclamation-triangle"></i> Alerta M√©dico</h2>
                    <button class="close-modal" id="close-alert" aria-label="Fechar alerta">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <p id="alert-message"></p>
                    <div class="alert-actions">
                        <button class="btn btn-primary" id="emergency-call">
                            <i class="fas fa-phone"></i>
                            Ligar para Emerg√™ncia
                        </button>
                        <button class="btn btn-secondary" id="find-doctor">
                            <i class="fas fa-user-md"></i>
                            Encontrar M√©dico
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Emergency Numbers Modal -->
        <div class="modal" id="emergency-numbers-modal">
            <div class="modal-content modal-emergency">
                <div class="modal-header">
                    <h3><i class="fas fa-phone-alt"></i> N√∫meros de Emerg√™ncia</h3>
                    <button class="close-modal" id="close-emergency-numbers" aria-label="Fechar n√∫meros de emerg√™ncia">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div class="emergency-numbers-list" id="emergency-numbers-list">
                        <!-- N√∫meros ser√£o inseridos via JavaScript -->
                    </div>
                    <div class="emergency-actions-footer">
                        <button class="btn-find-hospitals" id="btn-find-hospitals">
                            <i class="fas fa-hospital"></i>
                            Encontrar Hospitais Maternos Pr√≥ximos
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Hospitals Modal -->
        <div class="modal" id="hospitals-modal">
            <div class="modal-content modal-hospitals">
                <div class="modal-header">
                    <h3><i class="fas fa-hospital"></i> Hospitais Maternos Pr√≥ximos</h3>
                    <button class="close-modal" id="close-hospitals" aria-label="Fechar hospitais">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="hospitals-region-search" class="hospitals-region-search" style="margin-bottom: 0.75rem;">
                        <button type="button" id="btn-find-hospitals-my-region" class="btn-sophia btn-sophia-compact" style="font-size: 0.85rem;">
                            <i class="fas fa-location-crosshairs"></i> Atualizar localiza√ß√£o (GPS)
                        </button>
                    </div>
                    <div id="hospitals-loading" class="hospitals-loading" style="display: none;">
                        <div class="loading-content">
                            <i class="fas fa-spinner fa-spin"></i>
                            <p class="loading-main">Aguarde um instante...</p>
                            <p class="loading-sub">Estamos buscando hospitais pr√≥ximos √† sua localiza√ß√£o</p>
                        </div>
                    </div>
                    <div id="hospitals-error" class="hospitals-error" style="display: none;"></div>
                    <div id="hospitals-list" class="hospitals-list">
                        <!-- Hospitais ser√£o inseridos via JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Resources Modal -->
        <div class="modal" id="resources-modal">
            <div class="modal-content modal-resources">
                <div class="modal-header">
                    <h3 id="resources-title"></h3>
                    <button class="close-modal" id="close-resources" aria-label="Fechar recursos">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <div id="resources-content"></div>
                </div>
            </div>
        </div>

        <!-- Modal de Perfil do Usu√°rio -->
        <div class="modal" id="profile-modal">
            <div class="modal-content modal-profile">
                <div class="modal-header">
                    <h3><i class="fas fa-user-circle"></i> Perfil</h3>
                    <button class="close-modal" id="close-profile-modal" aria-label="Fechar perfil">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
                <div class="modal-body">
                    <form id="profile-form" class="profile-grid" autocomplete="off">
                        <div class="profile-card">
                            <h4>Sobre a m√£e</h4>
                            <label class="profile-label">Nome / Apelido
                                <input type="text" id="profile-mom-name" placeholder="Ex.: Maria / Mam√£e" />
                            </label>
                            <label class="profile-label">Fase
                                <select id="profile-mom-phase">
                                    <option value="">Selecione</option>
                                    <option value="puerperio-imediato">Puerp√©rio imediato (0-6 semanas)</option>
                                    <option value="puerperio-tardio">Puerp√©rio tardio (6 semanas - 6 meses)</option>
                                    <option value="puerperio-remoto">Puerp√©rio remoto (&gt; 6 meses)</option>
                                </select>
                            </label>
                            <label class="profile-label">Alergias
                                <input type="text" id="profile-mom-allergies" placeholder="Ex.: Lactose, penicilina" />
                            </label>
                            <label class="profile-label">Condi√ß√µes importantes
                                <textarea id="profile-mom-conditions" rows="2" placeholder="Ex.: Press√£o alta na gesta√ß√£o ‚Äî manter acompanhamento"></textarea>
                            </label>
                            <label class="profile-label">Contato de confian√ßa
                                <input type="text" id="profile-mom-contact" placeholder="Ex.: (11) 99999-9999" />
                            </label>
                        </div>

                        <div class="profile-card">
                            <h4>Sobre o beb√™</h4>
                            <label class="profile-label">Nome / Apelido
                                <input type="text" id="profile-baby-name" placeholder="Ex.: Beb√™ / Apelido carinhoso" />
                            </label>
                            <label class="profile-label">Data de nascimento
                                <input type="date" id="profile-baby-birth" />
                            </label>
                            <label class="profile-label">Pediatra
                                <input type="text" id="profile-baby-pediatrician" placeholder="Ex.: Dra. Ana ‚Äî (11) 98888-8888" />
                            </label>
                            <label class="profile-label">Alergias
                                <input type="text" id="profile-baby-allergies" placeholder="Ex.: Nenhuma informada" />
                            </label>
                            <label class="profile-label">Pr√≥ximas vacinas / lembretes
                                <textarea id="profile-baby-vaccines" rows="2" placeholder="Ex.: Consulte o calend√°rio ‚Äî lembrete configur√°vel"></textarea>
                            </label>
                        </div>

                        <div class="profile-card">
                            <h4>Cuidados e documentos</h4>
                            <label class="profile-label">Plano de parto / Pr√©-natal
                                <input type="text" id="profile-doc-plan" placeholder="Ex.: Guardar no celular" />
                            </label>
                            <label class="profile-label">Cart√£o do SUS / Conv√™nio
                                <input type="text" id="profile-doc-sus" placeholder="Ex.: Manter acess√≠vel" />
                            </label>
                            <label class="profile-label">Exames recentes
                                <input type="text" id="profile-doc-exams" placeholder="Ex.: Hemograma, glicemia, press√£o" />
                            </label>
                            <label class="profile-label">Apoios √∫teis
                                <textarea id="profile-doc-support" rows="2" placeholder="Ex.: Banco de leite, grupo de apoio p√≥s-parto"></textarea>
                            </label>
                            <label class="profile-label">Instru√ß√µes de emerg√™ncia
                                <textarea id="profile-doc-emergency" rows="2" placeholder="Ex.: Usar N√∫meros de Emerg√™ncia ou Hospitais Pr√≥ximos"></textarea>
                            </label>
                        </div>
                    </form>
                    <div class="profile-actions">
                        <button type="button" class="btn-sophia profile-save-btn" id="profile-save-btn">
                            <i class="fas fa-save"></i> Salvar dados
                        </button>
                        <button type="button" class="btn-sophia profile-clear-btn" id="profile-clear-btn">
                            <i class="fas fa-undo"></i> Limpar formul√°rio
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal Guia Visual de Autoexame -->
        <div class="modal" id="guia-autoexame-modal">
            <div class="modal-content modal-guia-autoexame">
                <div class="modal-header">
                    <h3><i class="fas fa-ribbon"></i> Sophia - Sua Companheira no Puerp√©rio: Guia Visual de Autoexame de Mama</h3>
                    <div class="modal-header-actions">
                        <button class="btn-modal-home" onclick="if (window.chatApp && typeof window.chatApp.backToWelcomeScreen === 'function') { window.chatApp.backToWelcomeScreen(); closeGuiaAutoexame(); }" aria-label="Voltar ao menu principal">
                            <i class="fas fa-home"></i> Voltar ao Menu
                        </button>
                        <button class="close-modal" id="close-guia-autoexame" aria-label="Fechar guia">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body modal-guia-body">
                    <div class="guia-aviso-medico">
                        <p><i class="fas fa-exclamation-triangle"></i> <strong>Importante:</strong> O autoexame √© uma t√©cnica de autoconhecimento para notar altera√ß√µes precoces, mas n√£o substitui o exame cl√≠nico realizado pelo seu ginecologista ou mastologista. Este guia √© para autoconhecimento. O autoexame n√£o substitui o rastreamento cl√≠nico profissional. Em caso de altera√ß√µes, procure seu m√©dico.</p>
                        <p style="margin-top: 0.5rem;"><i class="fas fa-stethoscope"></i> <strong>Lembre-se:</strong> O autoexame N√ÉO substitui a consulta m√©dica e a mamografia. Se encontrar qualquer altera√ß√£o, procure um m√©dico imediatamente.</p>
                    </div>
                    
                    <!-- Carrossel do Guia -->
                    <div class="guia-carousel-container">
                        <button class="guia-carousel-btn guia-carousel-prev" id="guia-prev" aria-label="Passo anterior">
                            <i class="fas fa-chevron-left"></i>
                        </button>
                        
                        <div class="guia-carousel-track" id="guia-carousel-track">
                            <!-- Passos ser√£o gerados dinamicamente -->
                        </div>
                        
                        <button class="guia-carousel-btn guia-carousel-next" id="guia-next" aria-label="Pr√≥ximo passo">
                            <i class="fas fa-chevron-right"></i>
                        </button>
                    </div>
                    
                    <!-- Indicadores de Passo -->
                    <div class="guia-indicators" id="guia-indicators">
                        <!-- Indicadores ser√£o gerados dinamicamente -->
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Modal Timeline de Cuidados -->
        <div class="modal" id="timeline-cuidados-modal">
            <div class="modal-content modal-timeline-cuidados">
                <div class="modal-header">
                    <h3><i class="fas fa-route"></i> Sophia - Sua Companheira no Puerp√©rio: Linha do Tempo de Cuidados</h3>
                    <div class="modal-header-actions">
                        <button class="btn-modal-home" onclick="if (window.chatApp && typeof window.chatApp.backToWelcomeScreen === 'function') { window.chatApp.backToWelcomeScreen(); closeTimelineCuidadosModal(); }" aria-label="Voltar ao menu principal">
                            <i class="fas fa-home"></i> Voltar ao Menu
                        </button>
                        <button class="close-modal" id="close-timeline-cuidados" aria-label="Fechar timeline">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
                <div class="modal-body modal-timeline-body">
                    <div class="timeline-aviso-medico">
                        <p><i class="fas fa-exclamation-triangle"></i> <strong>Importante:</strong> Esta linha do tempo √© apenas <strong>informativa e educativa</strong>. Este conte√∫do <strong>N√ÉO substitui consulta m√©dica profissional</strong>. Sempre consulte um profissional de sa√∫de qualificado para orienta√ß√µes personalizadas. <strong>Consulte sempre seu m√©dico para orienta√ß√µes espec√≠ficas.</strong></p>
                    </div>
                    
                    <!-- Toggle Per√≠odo -->
                    <div class="timeline-period-toggle">
                        <button class="timeline-period-btn active" data-period="gestacao">Gesta√ß√£o</button>
                        <button class="timeline-period-btn" data-period="parto">Parto</button>
                        <button class="timeline-period-btn" data-period="pos_parto">P√≥s-Parto</button>
                    </div>
                    
                    <!-- Timeline Stepper -->
                    <div class="timeline-stepper-container">
                        <div class="timeline-stepper" id="timeline-stepper">
                            <!-- Ser√° preenchido dinamicamente via JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Conte√∫do da Semana Selecionada -->
                    <div class="timeline-content" id="timeline-content">
                        <!-- Ser√° preenchido dinamicamente via JavaScript -->
                    </div>
                </div>
            </div>
        </div>
    </div>


    <!-- Scripts otimizados (defer para n√£o bloquear renderiza√ß√£o) -->
    <script>
        // Guia Autoexame Modal Functions
        function openGuiaAutoexame() {
            const guiaModal = document.getElementById('guia-autoexame-modal');
            if (guiaModal) {
                // Bloqueia scroll do body
                document.body.classList.add('modal-open');
                // Scroll para o topo
                window.scrollTo(0, 0);
                guiaModal.classList.add('show');
                // Carrega conte√∫do do guia sempre ao abrir para garantir renderiza√ß√£o
                if (window.chatApp && typeof window.chatApp.loadGuiaAutoexame === 'function') {
                    // For√ßa recarregamento para garantir que o conte√∫do seja renderizado
                    window.chatApp.loadGuiaAutoexame().then(() => {
                        // Ap√≥s carregar, garante que o primeiro passo est√° vis√≠vel
                        if (window.chatApp && typeof window.chatApp.goToGuiaStep === 'function') {
                            window.chatApp.goToGuiaStep(0);
                        }
                    });
                }
            }
        }
        
        function closeGuiaAutoexame() {
            const guiaModal = document.getElementById('guia-autoexame-modal');
            if (guiaModal) {
                guiaModal.classList.remove('show');
                // Remove bloqueio de scroll do body
                document.body.classList.remove('modal-open');
                // Scroll para o topo
                window.scrollTo(0, 0);
                // Gatilho proativo: Sophia envia mensagem ap√≥s fechar o modal
                setTimeout(() => {
                    if (window.chatApp && typeof window.chatApp.sendProactiveMessage === 'function') {
                        window.chatApp.sendProactiveMessage('Espero que as informa√ß√µes tenham ajudado! Voc√™ sabia que pode imprimir ou salvar um resumo desse guia para levar com voc√™?');
                    }
                }, 500); // Pequeno delay para a mensagem aparecer ap√≥s o modal fechar
            }
        }
        
        // Timeline de Cuidados Modal Functions
        function openTimelineCuidadosModal() {
            const timelineModal = document.getElementById('timeline-cuidados-modal');
            if (timelineModal) {
                // Bloqueia scroll do body
                document.body.classList.add('modal-open');
                // Scroll para o topo
                window.scrollTo(0, 0);
                timelineModal.classList.add('show');
                // Carrega conte√∫do da timeline apenas se ainda n√£o foi carregado
                if (window.chatApp && typeof window.chatApp.loadTimelineCuidados === 'function') {
                    const timelineStepper = document.getElementById('timeline-stepper');
                    if (!timelineStepper || timelineStepper.children.length === 0) {
                        window.chatApp.loadTimelineCuidados();
                    }
                }
            }
        }
        
        function closeTimelineCuidadosModal() {
            const timelineModal = document.getElementById('timeline-cuidados-modal');
            if (timelineModal) {
                timelineModal.classList.remove('show');
                // Remove bloqueio de scroll do body
                document.body.classList.remove('modal-open');
                // Scroll para o topo
                window.scrollTo(0, 0);
            }
        }

        // Close modal handlers
        document.addEventListener('DOMContentLoaded', function() {
            // Guia Autoexame Modal
            const closeGuiaBtn = document.getElementById('close-guia-autoexame');
            const guiaModal = document.getElementById('guia-autoexame-modal');
            
            if (closeGuiaBtn) {
                closeGuiaBtn.addEventListener('click', closeGuiaAutoexame);
            }
            
            if (guiaModal) {
                guiaModal.addEventListener('click', function(e) {
                    if (e.target === guiaModal) {
                        closeGuiaAutoexame();
                    }
                });
            }
            
            // Timeline de Cuidados Modal
            const closeTimelineBtn = document.getElementById('close-timeline-cuidados');
            const timelineModal = document.getElementById('timeline-cuidados-modal');
            
            if (closeTimelineBtn) {
                closeTimelineBtn.addEventListener('click', closeTimelineCuidadosModal);
            }
            
            if (timelineModal) {
                timelineModal.addEventListener('click', function(e) {
                    if (e.target === timelineModal) {
                        closeTimelineCuidadosModal();
                    }
                });
            }
        });
    </script>
    <!-- chat.js carregado tamb√©m na p√°gina de login para Cadastrar/Entrar funcionarem (chatApp) -->
    {% if page == 'login' %}
    <script src="{{ url_for('static', filename='js/boot.js') }}?v={{ timestamp }}" defer></script>
    {% if timestamp %}
    <script src="{{ url_for('static', filename='js/chat.js') }}?v={{ timestamp }}" defer></script>
    {% else %}
    <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
    {% endif %}
    {% else %}
    <script src="{{ url_for('static', filename='js/boot.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/action-dispatcher.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/device-detector.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/api-client.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/toast-notification.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/sidebar-content.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/vaccination-timeline.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/mobile-navigation.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/badges.js') }}?v={{ timestamp }}" defer></script>
    {% if has_minified and timestamp %}
    <script src="{{ url_for('static', filename='js/chat.min.js') }}?v={{ timestamp }}" defer></script>
    {% elif timestamp %}
    <script src="{{ url_for('static', filename='js/chat.js') }}?v={{ timestamp }}" defer></script>
    {% else %}
    <script src="{{ url_for('static', filename='js/chat.js') }}" defer></script>
    {% endif %}
    {% endif %}
    <script src="{{ url_for('static', filename='js/nearby-wire.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/chat-header-offset.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/card-ownership-integrated.js') }}?v={{ timestamp }}" defer></script>
    {% if config.DEBUG %}
    <script src="{{ url_for('static', filename='js/skeleton-toggle-dev.js') }}?v={{ timestamp }}" defer></script>
    {% endif %}
    <script src="{{ url_for('static', filename='js/edu-cards-wire.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/theme-polish-wire.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/categories-cards-wire.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/categories-filters-wire.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/categories-skeleton-wire.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/nearby-skeleton-wire.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/hospitals-skeleton-wire.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/auth-cache-buster.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/privacy-storage-guard.js') }}?v={{ timestamp }}" defer></script>
    <script src="{{ url_for('static', filename='js/hospital-cards-emergency.js') }}?v={{ timestamp }}" defer></script>
    
    <!-- Silenciar erros de extens√µes do navegador (n√£o afetam o funcionamento do site) -->
    <script>
        // Handler global para silenciar erros conhecidos de extens√µes do navegador
        window.addEventListener('error', function(event) {
            // Silencia erros de extens√µes do Chrome/Edge que tentam interceptar mensagens
            if (event.message && (
                event.message.includes('listener indicated an asynchronous response') ||
                event.message.includes('message channel closed') ||
                event.message.includes('Extension context invalidated')
            )) {
                event.preventDefault();
                return false;
            }
        }, true);
        
        // Silencia erros de Promise rejeitadas de extens√µes
        window.addEventListener('unhandledrejection', function(event) {
            if (event.reason && (
                event.reason.message && (
                    event.reason.message.includes('listener indicated an asynchronous response') ||
                    event.reason.message.includes('message channel closed') ||
                    event.reason.message.includes('Extension context invalidated')
                )
            )) {
                event.preventDefault();
                return false;
            }
        });
    </script>
    
    <!-- Aviso m√©dico colaps√°vel (accordion) -->
    <script>
        (function() {
            function initDisclaimerAccordion() {
                var btn = document.getElementById('medical-disclaimer-toggle');
                var content = document.getElementById('medical-disclaimer-content');
                var wrap = btn && btn.closest('.medical-disclaimer-accordion');
                if (!btn || !content || !wrap) return;
                btn.addEventListener('click', function() {
                    var isOpen = !content.hidden;
                    content.hidden = isOpen;
                    btn.setAttribute('aria-expanded', !isOpen);
                    wrap.classList.toggle('expanded', !isOpen);
                });
            }
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', initDisclaimerAccordion);
            } else {
                initDisclaimerAccordion();
            }
        })();
    </script>
    
    <!-- Agenda de Vacina√ß√£o: lembretes e modal Adicionar lembrete -->
    <script>
        (function() {
            var modal = document.getElementById('vaccination-reminder-modal');
            var wrap = document.getElementById('agenda-reminders-wrap');
            var btnAdd = document.getElementById('btn-add-reminder');
            var form = document.getElementById('form-vaccination-reminder');
            var closeBtn = document.getElementById('close-vaccination-reminder-modal');
            var cancelBtn = document.getElementById('cancel-vaccination-reminder');
            
            function openModal() {
                if (modal) modal.style.display = 'flex';
                document.body.style.overflow = 'hidden';
            }
            function closeModal() {
                if (modal) modal.style.display = 'none';
                document.body.style.overflow = '';
            }
            
            function isTomorrow(dateStr) {
                if (!dateStr) return false;
                var today = new Date();
                var d = new Date(dateStr);
                var tomorrow = new Date(today);
                tomorrow.setDate(tomorrow.getDate() + 1);
                return d.getFullYear() === tomorrow.getFullYear() && d.getMonth() === tomorrow.getMonth() && d.getDate() === tomorrow.getDate();
            }
            function renderReminders(upcoming, taken) {
                if (!wrap) return;
                upcoming = upcoming || [];
                taken = taken || [];
                window.__agendaTomorrowFromReminders = upcoming.some(function(r) { return isTomorrow(r.data); });
                if (typeof window.applyAgendaCardTomorrowAlert === 'function') window.applyAgendaCardTomorrowAlert();
                if (upcoming.length === 0 && taken.length === 0) {
                    wrap.innerHTML = '';
                    return;
                }
                var html = '';
                if (upcoming.length > 0) {
                    html += '<p style="font-size: 0.85rem; color: #6b4a3f; margin-bottom: 0.35rem;"><strong>Pr√≥ximas</strong></p><ul class="agenda-reminders-list" style="margin: 0 0 0.75rem 1.25rem; padding: 0; font-size: 0.85rem; color: #6b4a3f;">' +
                        upcoming.map(function(r) {
                            return '<li style="margin-bottom: 0.35rem;">' + escapeHtml(r.vacina) + ' ‚Äì ' + escapeHtml(r.data) + (r.hora ? ' √†s ' + escapeHtml(r.hora) : '') + ' ‚Äì ' + escapeHtml(r.local) + '</li>';
                        }).join('') + '</ul>';
                }
                if (taken.length > 0) {
                    html += '<p style="font-size: 0.8rem; color: #8b7355; margin-bottom: 0.35rem;"><strong>Tomadas</strong></p><ul class="agenda-reminders-taken" style="margin: 0 0 0 1.25rem; padding: 0; font-size: 0.8rem; color: #8b7355;">' +
                        taken.map(function(r) {
                            return '<li style="margin-bottom: 0.25rem;">' + escapeHtml(r.vacina) + ' ‚Äì ' + escapeHtml(r.data) + (r.hora ? ' √†s ' + escapeHtml(r.hora) : '') + ' ‚Äì ' + escapeHtml(r.local) + '</li>';
                        }).join('') + '</ul>';
                }
                wrap.innerHTML = html;
            }
            function escapeHtml(s) {
                if (s == null) return '';
                var div = document.createElement('div');
                div.textContent = s;
                return div.innerHTML;
            }
            
            function loadReminders() {
                var api = window.apiClient || {};
                var fetchOpts = { credentials: 'include', headers: { 'Accept': 'application/json' } };
                var url = '/api/v1/vaccination/reminders';
                if (typeof api.get === 'function') {
                    api.get(url).then(function(res) {
                        if (res) renderReminders(res.upcoming || [], res.taken || []);
                    }).catch(function() { renderReminders([], []); });
                } else {
                    fetch(url, fetchOpts).then(function(r) { return r.json(); }).then(function(res) {
                        if (res) renderReminders(res.upcoming || [], res.taken || []);
                    }).catch(function() { renderReminders([], []); });
                }
            }
            
            function submitReminder(e) {
                e.preventDefault();
                var vacina = document.getElementById('reminder-vacina').value.trim();
                var data = document.getElementById('reminder-data').value.trim();
                var hora = document.getElementById('reminder-hora').value.trim();
                var local = document.getElementById('reminder-local').value.trim();
                if (!vacina || !data || !local) return;
                var payload = { vacina: vacina, data: data, hora: hora || '08:00', local: local };
                var api = window.apiClient || {};
                var fetchOpts = { method: 'POST', credentials: 'include', headers: { 'Content-Type': 'application/json', 'Accept': 'application/json' }, body: JSON.stringify(payload) };
                if (typeof api.post === 'function') {
                    api.post('/api/v1/vaccination/add', payload).then(function(res) {
                        if (res && res.success) { closeModal(); form.reset(); loadReminders(); }
                    }).catch(function() {});
                } else {
                    fetch('/api/v1/vaccination/add', fetchOpts).then(function(r) { return r.json(); }).then(function(res) {
                        if (res && res.success) { closeModal(); form.reset(); loadReminders(); }
                    }).catch(function() {});
                }
            }
            
            if (btnAdd) btnAdd.addEventListener('click', openModal);
            if (closeBtn) closeBtn.addEventListener('click', closeModal);
            if (cancelBtn) cancelBtn.addEventListener('click', closeModal);
            if (modal && modal.querySelector('.modal-content')) {
                modal.addEventListener('click', function(ev) { if (ev.target === modal) closeModal(); });
            }
            if (form) form.addEventListener('submit', submitReminder);
            
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() { setTimeout(loadReminders, 800); });
            } else {
                setTimeout(loadReminders, 800);
            }
        })();
    </script>
    
    <!-- Prefetch para recursos n√£o cr√≠ticos (ap√≥s carregamento inicial) -->
    <script>
        // Carrega recursos n√£o cr√≠ticos ap√≥s o carregamento da p√°gina
        window.addEventListener('load', function() {
            var link = document.createElement('link');
            link.rel = 'prefetch';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-solid-900.woff2';
            document.head.appendChild(link);
            
            var link2 = document.createElement('link');
            link2.rel = 'prefetch';
            link2.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/webfonts/fa-regular-400.woff2';
            document.head.appendChild(link2);
        });
    </script>
    
    <!-- Rodap√© de Compliance (sempre vis√≠vel) -->
    <footer id="compliance-footer" class="compliance-footer">
        <div class="compliance-footer-content">
            <div class="compliance-footer-text">
                <p class="compliance-project-name">Sophia - Sua Companheira no Puerp√©rio</p>
                <p class="compliance-disclaimer">
                    Este site √© estritamente <strong>informativo e educativo</strong> e <strong>N√ÉO substitui</strong> consulta m√©dica profissional, diagn√≥stico ou tratamento m√©dico. 
                    Todas as informa√ß√µes fornecidas seguem rigorosamente a <strong>Lei do Ato M√©dico</strong> (Lei n¬∫ 12.842/2013) e o <strong>C√≥digo de √âtica M√©dica do CFM</strong>. 
                    Sempre consulte um profissional de sa√∫de qualificado para orienta√ß√µes personalizadas. 
                    Em emerg√™ncias, ligue <strong>192 (SAMU)</strong>.
                </p>
            </div>
        </div>
    </footer>
    
    <!-- Container Mobile Dicas (Oculto por padr√£o, aparece quando aba Dicas est√° ativa) -->
    <div id="mobile-dicas-container" class="mobile-section">
        <!-- Conte√∫do ser√° preenchido dinamicamente via JavaScript -->
    </div>
    
    <!-- ========================================
         HACK JAVASCRIPT - Corre√ß√£o For√ßada do Bot√£o Sophia
         ======================================== -->
    <!-- Este script for√ßa a corre√ß√£o do bot√£o #start-chat-btn e container .start-chat-container -->
    <!-- caso estilos inline ou outros c√≥digos tentem sobrescrever o CSS -->
    <script>
        // Fun√ß√£o para for√ßar a corre√ß√£o - PODE SER CHAMADA DE QUALQUER LUGAR
        function fixSophiaButton() {
            // Seleciona o container
            var container = document.querySelector('.start-chat-container');
            if (container) {
                container.style.cssText = "width: 100% !important; max-width: 100% !important; display: flex !important; justify-content: center !important; align-items: center !important; padding: 0 !important; margin: 0 !important; float: none !important; box-sizing: border-box !important;";
            }

            // Seleciona o bot√£o
            var btn = document.querySelector('#start-chat-btn');
            if (btn) {
                // CORRE√á√ÉO CR√çTICA: For√ßa centraliza√ß√£o e cores via JavaScript inline (prioridade m√°xima)
                btn.style.setProperty('width', '100%', 'important');
                btn.style.setProperty('max-width', '260px', 'important');
                btn.style.setProperty('height', '50px', 'important');
                btn.style.setProperty('display', 'flex', 'important');
                btn.style.setProperty('align-items', 'center', 'important');
                btn.style.setProperty('justify-content', 'center', 'important');
                btn.style.setProperty('margin', '20px auto 30px auto', 'important');
                btn.style.setProperty('padding', '0', 'important');
                btn.style.setProperty('box-sizing', 'border-box', 'important');
                btn.style.setProperty('background-color', '#ffffff', 'important');
                btn.style.setProperty('text-align', 'center', 'important');
                
                // CORRE√á√ÉO CR√çTICA: For√ßa a cor rosa no span (texto) via JavaScript inline + centraliza√ß√£o
                var span = btn.querySelector('span');
                if (span) {
                    span.style.setProperty('color', '#d68b98', 'important');
                    span.style.setProperty('display', 'block', 'important');
                    span.style.setProperty('text-align', 'center', 'important');
                    span.style.setProperty('line-height', '1.4', 'important');
                    span.style.setProperty('margin', '0', 'important');
                    span.style.setProperty('padding', '0', 'important');
                    span.style.setProperty('width', '100%', 'important');
                }
                
                // Remove qualquer √≠cone que possa ter sido adicionado
                var icon = btn.querySelector('i, svg');
                if (icon) {
                    icon.remove(); // Remove o √≠cone completamente
                }
            }
        }

        // Executa quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', fixSophiaButton);
        } else {
            fixSophiaButton();
        }

        // Executa quando janela estiver completamente carregada
        window.addEventListener('load', function() {
            fixSophiaButton();
            // Tenta rodar de novo ap√≥s delays (caso outros scripts interfiram)
            setTimeout(fixSophiaButton, 500);
            setTimeout(fixSophiaButton, 1000);
            setTimeout(fixSophiaButton, 2000);
            setTimeout(fixSophiaButton, 3000);
        });

        // Executa quando p√°gina estiver totalmente pronta (fallback extra)
        if (document.readyState === 'complete') {
            setTimeout(fixSophiaButton, 100);
        }

        // OBSERVER: Monitora mudan√ßas no DOM e reaplica estilos se necess√°rio
        var observer = new MutationObserver(function(mutations) {
            var btn = document.querySelector('#start-chat-btn');
            if (btn) {
                // Se o estilo inline foi removido ou alterado, reaplica
                var hasInlineStyles = btn.style.length > 0;
                if (!hasInlineStyles || !btn.style.getPropertyValue('justify-content') || 
                    btn.style.getPropertyValue('justify-content') !== 'center') {
                    fixSophiaButton();
                }
            }
        });

        // Inicia observa√ß√£o quando DOM estiver pronto
        if (document.readyState === 'loading') {
            document.addEventListener('DOMContentLoaded', function() {
                var btn = document.querySelector('#start-chat-btn');
                if (btn) {
                    observer.observe(btn, {
                        attributes: true,
                        attributeFilter: ['style', 'class'],
                        childList: true,
                        subtree: true
                    });
                }
            });
        } else {
            var btn = document.querySelector('#start-chat-btn');
            if (btn) {
                observer.observe(btn, {
                    attributes: true,
                    attributeFilter: ['style', 'class'],
                    childList: true,
                    subtree: true
                });
            }
        }

        // Garante execu√ß√£o ap√≥s chat.js (se existir)
        if (typeof window.chatApp !== 'undefined') {
            setTimeout(fixSophiaButton, 100);
        }
        
        // Escuta se chatApp for criado depois
        var chatAppCheckInterval = setInterval(function() {
            if (typeof window.chatApp !== 'undefined') {
                clearInterval(chatAppCheckInterval);
                setTimeout(fixSophiaButton, 200);
            }
        }, 500);
        
        // Para o intervalo ap√≥s 10 segundos
        setTimeout(function() {
            clearInterval(chatAppCheckInterval);
        }, 10000);
    </script>

    <!-- Baby Profile Onboarding Script -->
    <script>
        (function() {
            'use strict';
            
            // Define data m√°xima como hoje (n√£o pode nascer no futuro)
            const birthDateInput = document.getElementById('baby-birth-date-input');
            if (birthDateInput) {
                const today = new Date().toISOString().split('T')[0];
                birthDateInput.setAttribute('max', today);
            }
            
            // Verifica se usu√°rio tem perfil de beb√™ e abre modal se necess√°rio
            async function checkBabyProfile() {
                try {
                    // Verifica se usu√°rio est√° logado (deduped: evita chamada duplicada em 2s)
                    const userData = window.dedupedFetchJSON
                        ? await window.dedupedFetchJSON('/api/user', { credentials: 'include' }).catch(function() { return null; })
                        : await fetch('/api/user', { credentials: 'include' }).then(function(r) { return r.ok ? r.json() : null; });
                    if (!userData) {
                        return; // Usu√°rio n√£o est√° logado
                    }
                    
                    // Verifica se tem perfil de beb√™
                    const babyProfileResponse = await fetch('/api/baby_profile', { 
                        credentials: 'include',
                        method: 'GET'
                    });
                    
                    if (babyProfileResponse.status === 404) {
                        // N√£o tem perfil - abre modal
                        const modal = document.getElementById('baby-profile-modal');
                        if (modal) {
                            modal.style.display = 'flex';
                            // Foca no primeiro input
                            const nameInput = document.getElementById('baby-name-input');
                            if (nameInput) {
                                setTimeout(() => nameInput.focus(), 300);
                            }
                        }
                    }
                } catch (error) {
                    console.log('[BabyProfile] Erro ao verificar perfil:', error);
                }
            }
            
            // Handler do formul√°rio
            const form = document.getElementById('baby-profile-form');
            if (form) {
                form.addEventListener('submit', async function(e) {
                    e.preventDefault();
                    
                    const submitBtn = document.getElementById('baby-profile-submit-btn');
                    const errorDiv = document.getElementById('baby-profile-error');
                    const nameInput = document.getElementById('baby-name-input');
                    const birthDateInput = document.getElementById('baby-birth-date-input');
                    
                    // Valida√ß√µes
                    const name = nameInput.value.trim();
                    const birthDate = birthDateInput.value;
                    
                    if (!name) {
                        errorDiv.textContent = 'Por favor, informe o nome do beb√™.';
                        errorDiv.style.display = 'block';
                        nameInput.focus();
                        return;
                    }
                    
                    if (!birthDate) {
                        errorDiv.textContent = 'Por favor, informe a data de nascimento.';
                        errorDiv.style.display = 'block';
                        birthDateInput.focus();
                        return;
                    }
                    
                    // Desabilita bot√£o e mostra loading
                    submitBtn.disabled = true;
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin" style="margin-right: 0.5rem;"></i> Salvando...';
                    errorDiv.style.display = 'none';
                    
                    try {
                        const response = await fetch('/api/baby_profile', {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json'
                            },
                            credentials: 'include',
                            body: JSON.stringify({
                                name: name,
                                birth_date: birthDate
                            })
                        });
                        
                        const data = await response.json();
                        
                        if (response.ok && data.success) {
                            // Sucesso - fecha modal e recarrega p√°gina
                            const modal = document.getElementById('baby-profile-modal');
                            if (modal) {
                                modal.style.display = 'none';
                            }
                            
                            // Recarrega a p√°gina para atualizar o calend√°rio de vacina√ß√£o
                            setTimeout(() => {
                                window.location.reload();
                            }, 500);
                        } else {
                            // Erro
                            errorDiv.textContent = data.message || data.error || 'Erro ao salvar perfil do beb√™. Tente novamente.';
                            errorDiv.style.display = 'block';
                            submitBtn.disabled = false;
                            submitBtn.innerHTML = '<i class="fas fa-heart" style="margin-right: 0.5rem;"></i> Salvar e Come√ßar';
                        }
                    } catch (error) {
                        console.error('[BabyProfile] Erro ao salvar:', error);
                        errorDiv.textContent = 'Erro ao conectar com o servidor. Verifique sua conex√£o e tente novamente.';
                        errorDiv.style.display = 'block';
                        submitBtn.disabled = false;
                        submitBtn.innerHTML = '<i class="fas fa-heart" style="margin-right: 0.5rem;"></i> Salvar e Come√ßar';
                    }
                });
            }
            
            // Verifica perfil quando a p√°gina carrega (ap√≥s login)
            // Aguarda um pouco para garantir que o usu√°rio est√° logado
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', function() {
                    setTimeout(checkBabyProfile, 1500);
                });
            } else {
                setTimeout(checkBabyProfile, 1500);
            }
            
            // Tamb√©m verifica quando o chatApp inicializa (caso o login seja feito depois)
            if (typeof window.chatApp !== 'undefined') {
                window.chatApp.addEventListener('login', function() {
                    setTimeout(checkBabyProfile, 1000);
                });
            }
            
            // Escuta mudan√ßas no chatApp (login/logout)
            let chatAppCheckInterval = setInterval(function() {
                if (typeof window.chatApp !== 'undefined' && window.chatApp.userLoggedIn) {
                    clearInterval(chatAppCheckInterval);
                    setTimeout(checkBabyProfile, 1000);
                }
            }, 500);
            
            // Para o intervalo ap√≥s 10 segundos
            setTimeout(function() {
                clearInterval(chatAppCheckInterval);
            }, 10000);
        })();
    </script>
</body>
</html>

